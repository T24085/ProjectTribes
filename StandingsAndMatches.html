<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPL Standings and Matches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">
    <div id="nav-placeholder" data-include="/nav.html"></div>

  <div class="w-full max-w-4xl p-4">
    <h1 class="text-2xl font-bold text-center mb-4">TPL Standings and Matches</h1>
    <div class="flex flex-col md:flex-row gap-4 justify-center mb-6">
      <div>
        <label class="block text-sm mb-1">Season</label>
        <select id="lmSeason" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Division</label>
        <select id="lmDivision" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
    </div>

    <div>
      <h2 class="text-xl font-semibold mb-2">Standings</h2>
      <table id="standingsTable" class="min-w-full text-left"></table>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-semibold mb-2">Schedule</h2>
      <div id="scheduleContainer"></div>
    </div>
  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);


    let seasonsIndex = [];
    let currentSeasonData = null;

    async function loadSeasons() {
      const seasonSelect = document.getElementById('lmSeason');
      seasonSelect.innerHTML = '';
      const snap = await getDocs(collection(db, 'leagueSeasons'));
      seasonsIndex = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => parseInt(a.id) - parseInt(b.id));
      seasonsIndex.forEach(season => {
        const opt = document.createElement('option');
        opt.value = season.id;
        opt.textContent = `Season ${season.id}`;
        seasonSelect.appendChild(opt);
      });
      const active = seasonsIndex.find(s => s.active) || seasonsIndex[seasonsIndex.length - 1];
      if (active) {
        seasonSelect.value = active.id;
        await loadSeasonData(active.id);
      }
    }

    async function loadSeasonData(id) {
      const snap = await getDoc(doc(db, 'leagueSeasons', String(id)));
      if (!snap.exists()) return;
      currentSeasonData = snap.data();
      currentSeasonData.season = parseInt(id);
      const divisionSelect = document.getElementById('lmDivision');
      divisionSelect.innerHTML = '';
      Object.keys(currentSeasonData.divisions || {}).forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        divisionSelect.appendChild(opt);
      });
      if (divisionSelect.options.length > 0) {
        divisionSelect.value = divisionSelect.options[0].value;
      }

      await renderDivision();
    }

    async function fetchTeams(season, division) {
      const q = query(
        collection(db, 'teams'),
        where('season', '==', season),
        where('division', '==', division),
        where('approved', '==', true)
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }

    async function renderDivision() {
      const divKey = document.getElementById('lmDivision').value;
      const season = currentSeasonData.season;

      const teamDocs = await fetchTeams(season, divKey);
      const teamNames = teamDocs.map(t => t.teamName);

      const scheduleRef = doc(db, 'leagueSchedules', `${season}-${divKey}`);
      const snap = await getDoc(scheduleRef);
      const weeks = snap.exists() ? (snap.data().weeks || []) : [];

      const allTeams = new Set(teamNames);
      weeks.forEach(w => w.matches.forEach(m => { allTeams.add(m.home); allTeams.add(m.away); }));

      const standings = computeStandings(weeks, Array.from(allTeams));
      renderStandings(standings);
      renderSchedule(weeks);
    }

    function computeStandings(weeks, teams) {
      const table = {};
      teams.forEach(t => (table[t] = { team: t, wins: 0, losses: 0 }));
      weeks.forEach(w => {
        if (w.phase && w.phase !== 'regular') return;
        w.matches.forEach(m => {
          if (m.homeScore != null && m.awayScore != null) {
            if (m.homeScore > m.awayScore) {
              table[m.home].wins++;
              table[m.away].losses++;
            } else if (m.awayScore > m.homeScore) {
              table[m.away].wins++;
              table[m.home].losses++;
            }
          }
        });
      });
      return Object.values(table);
    }

    function renderStandings(rows) {
      const table = document.getElementById('standingsTable');
      table.innerHTML = '';
      const header = document.createElement('tr');
      header.innerHTML = '<th class="px-2">Team</th><th class="px-2">W</th><th class="px-2">L</th>';
      table.appendChild(header);
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-2">${r.team}</td><td class="px-2">${r.wins}</td><td class="px-2">${r.losses}</td>`;
        table.appendChild(tr);
      });
    }

    function renderSchedule(weeks) {
      const container = document.getElementById('scheduleContainer');
      container.innerHTML = '';
      weeks.forEach(w => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        const title = document.createElement('h3');
        title.className = 'font-semibold mb-1';
        title.textContent = `Week ${w.week}`;
        div.appendChild(title);
        const ul = document.createElement('ul');
        w.matches.forEach(m => {
          const li = document.createElement('li');
          const score = (m.homeScore != null && m.awayScore != null) ? ` ${m.awayScore} - ${m.homeScore}` : '';
          li.textContent = `${m.date}: ${m.away} @ ${m.home}${score}`;
          ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
      });
    }

    document.getElementById('lmSeason').addEventListener('change', e => loadSeasonData(e.target.value));
    document.getElementById('lmDivision').addEventListener('change', renderDivision);

    loadSeasons();
  </script>
    <script>
      async function loadNav() {
        const placeholder = document.getElementById('nav-placeholder');
        try {
          const res = await fetch('./nav.html');
          if (!res.ok) throw new Error(`Nav fetch failed: ${res.status}`);
          const html = await res.text();
          placeholder.innerHTML = html;
          placeholder.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
            newScript.textContent = oldScript.textContent;
            oldScript.replaceWith(newScript);
          });
          if (window.twitchOAuth) {
            window.twitchOAuth.updateNav();
            window.twitchOAuth.initLiveTeamsMenu();
          }
        } catch (err) {
          console.error('Failed to load navigation', err);
        }
      }
      loadNav();
    </script>
  </body>
</html>
