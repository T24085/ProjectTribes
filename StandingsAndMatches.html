<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPL Standings and Matches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="oauth.js"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #1d4ed8 100%);
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
    }
    .standings-row {
      transition: all 0.2s ease;
    }
    .standings-row:hover {
      background-color: rgba(59, 130, 246, 0.1);
    }
    .playoff-glow {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    .match-item {
      transition: all 0.2s ease;
    }
    .match-item:hover {
      background-color: rgba(59, 130, 246, 0.05);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 text-white min-h-screen">
    <div id="nav-placeholder" data-include="nav.html"></div>

  <div class="w-full max-w-7xl mx-auto p-6">
    <!-- Header Section -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent mb-2">
        TPL Standings & Matches
      </h1>
      <p class="text-gray-300 text-lg">Track your team's progress through the season</p>
    </div>

    <!-- Controls Section -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-6 mb-8 border border-gray-700/50">
      <div class="flex flex-col sm:flex-row gap-6 justify-center items-end">
        <div class="flex-1 max-w-xs">
          <label class="block text-sm font-medium text-gray-300 mb-2">Season</label>
          <select id="lmSeason" class="w-full px-4 py-3 rounded-xl bg-gray-700/80 border border-gray-600/50 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
          </select>
        </div>
        <div class="flex-1 max-w-xs">
          <label class="block text-sm font-medium text-gray-300 mb-2">Division</label>
          <select id="lmDivision" class="w-full px-4 py-3 rounded-xl bg-gray-700/80 border border-gray-600/50 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
          </select>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
      <!-- Standings Section -->
      <section class="bg-gray-800/30 backdrop-blur-sm rounded-2xl border border-gray-700/50 card-hover">
        <div class="p-6 border-b border-gray-700/50">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-white">League Standings</h2>
          </div>
        </div>
        <div class="p-6">
          <div class="overflow-x-auto">
            <table id="standingsTable" class="w-full text-left"></table>
          </div>
        </div>
      </section>

      <!-- Schedule Section -->
      <section class="bg-gray-800/30 backdrop-blur-sm rounded-2xl border border-gray-700/50 card-hover">
        <div class="p-6 border-b border-gray-700/50">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-r from-green-400 to-blue-500 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-white">Match Schedule</h2>
          </div>
        </div>
        <div class="p-6">
          <div id="scheduleContainer" class="space-y-4"></div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const staticLogos = {
      // Avalanche
      'AV': 'images/aV!.png',
      'AVALANCHE': 'images/aV!.png',
      // DPRK
      'DPRK': 'images/TeamDPRKLogo3.png',
      // Flag Pole Smokers
      'FPS': 'images/FPSlogo.png',
      'FLAGPOLESMOKERS': 'images/FPSlogo.png',
      // Flying Tractors
      'FT': 'images/FTlogo.png',
      'FLYINGTRACTORS': 'images/FTlogo.png',
      // Hegemony of Euros
      'HOE': 'images/HoE.png',
      'HEGEMONYOFEUROS': 'images/HoE.png',
      // KTL
      'KTL': 'images/KTLlogo.png',
      'KICKTOLOBBY': 'images/KTLlogo.png',
      'KICK TO LOBBY': 'images/KTLlogo.png',
      'KICKEDTOLOBBY': 'images/KTLlogo.png',
      'KICKED TO LOBBY': 'images/KTLlogo.png',
      // Magic
      'MAGIC': 'images/Magic.png',
      // TXM
      'TXM': 'images/TXM.png',
      'TEXASMILITIA': 'images/TXM.png',
      // Unhandled Exception
      'UE': 'images/UE.png',
      'UNHANDLEDEXCEPTION': 'images/UE.png',
      // Zen
      'ZEN': 'images/Zenlogo.png',
      // ePidemic
      'EPI': 'images/ePi.png',
      'EPIDEMIC': 'images/ePi.png',
      // null
      'NULL': 'images/NullLogo.png',
      // Toxic Aimers
      'TOXICAIMERS': 'images/ToxicAimersLogo.png',
      // DeadStop
      'DS': 'DeadStopLogo.png',
      'DEADSTOP': 'DeadStopLogo.png'
    };


    function normalizeName(name) {
      return name.replace(/\W/g, '').toUpperCase();
    }

    function getLogo(name) {
      const bracket = name.match(/\[(.+?)\]/);
      if (bracket) {
        const key = normalizeName(bracket[1]);
        if (teamLogos[key]) return teamLogos[key];
      }
      return teamLogos[normalizeName(name)];
    }


    let teamLogos = { ...staticLogos };
    let seasonsIndex = [];
    let currentSeasonData = null;

    async function loadSeasons() {
      const seasonSelect = document.getElementById('lmSeason');
      seasonSelect.innerHTML = '';
      const snap = await getDocs(collection(db, 'leagueSeasons'));
      seasonsIndex = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => parseInt(a.id) - parseInt(b.id));
      seasonsIndex.forEach(season => {
        const opt = document.createElement('option');
        opt.value = season.id;
        opt.textContent = `Season ${season.id}`;
        seasonSelect.appendChild(opt);
      });
      const active = seasonsIndex.find(s => s.active) || seasonsIndex[seasonsIndex.length - 1];
      if (active) {
        seasonSelect.value = active.id;
        await loadSeasonData(active.id);
      }
    }

    async function loadSeasonData(id) {
      const snap = await getDoc(doc(db, 'leagueSeasons', String(id)));
      if (!snap.exists()) return;
      currentSeasonData = snap.data();
      currentSeasonData.season = parseInt(id);
      const divisionSelect = document.getElementById('lmDivision');
      divisionSelect.innerHTML = '';
      Object.keys(currentSeasonData.divisions || {}).forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        divisionSelect.appendChild(opt);
      });
      if (divisionSelect.options.length > 0) {
        divisionSelect.value = divisionSelect.options[0].value;
      }

      await renderDivision();
    }

    async function fetchTeams(season, division) {
      const q = query(
        collection(db, 'teams'),
        where('season', '==', season),
        where('division', '==', division),
        where('approved', '==', true)
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }

    async function renderDivision() {
      const divKey = document.getElementById('lmDivision').value;
      const season = currentSeasonData.season;

      const teamDocs = await fetchTeams(season, divKey);
      const teamNames = teamDocs.map(t => t.teamName);
      teamLogos = { ...staticLogos };
      teamDocs.forEach(t => {
        if (t.logoUrl) {
          const fullKey = normalizeName(t.teamName);
          teamLogos[fullKey] = t.logoUrl;
          const bracket = t.teamName.match(/\[(.+?)\]/);
          if (bracket) {
            teamLogos[normalizeName(bracket[1])] = t.logoUrl;
          }
        }
      });

      const scheduleRef = doc(db, 'leagueSchedules', `${season}-${divKey}`);
      const snap = await getDoc(scheduleRef);
      const weeks = snap.exists() ? (snap.data().weeks || []) : [];

      const allTeams = new Set(teamNames);
      weeks.forEach(w => w.matches.forEach(m => { allTeams.add(m.home); allTeams.add(m.away); }));

      const teams = Array.from(allTeams);
      const standings = computeStandings(weeks, teams);
      const playoffTeams = determinePlayoffTeams(weeks, 4, teams);
      renderStandings(standings, playoffTeams);
      renderSchedule(weeks);
    }

    function computeStandings(weeks, teams) {
      const table = {};
      teams.forEach(t => (table[t] = { team: t, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0 }));
      weeks.forEach(w => {
        if (w.phase && w.phase !== 'regular') return;
        w.matches.forEach(m => {
          if (m.homeScore != null && m.awayScore != null) {
            table[m.home].pointsFor += m.homeScore;
            table[m.home].pointsAgainst += m.awayScore;
            table[m.away].pointsFor += m.awayScore;
            table[m.away].pointsAgainst += m.homeScore;
            if (m.homeScore > m.awayScore) {
              table[m.home].wins++;
              table[m.away].losses++;
            } else if (m.awayScore > m.homeScore) {
              table[m.away].wins++;
              table[m.home].losses++;
            }
          }
        });
      });
      return Object.values(table).map(r => {
        const games = r.wins + r.losses;
        const winPct = games ? r.wins / games : 0;
        const pointDiff = r.pointsFor - r.pointsAgainst;
        return { ...r, winPct, pointDiff };
      }).sort((a, b) => {
        if (b.winPct !== a.winPct) return b.winPct - a.winPct;
        if (b.pointDiff !== a.pointDiff) return b.pointDiff - a.pointDiff;
        return a.team.localeCompare(b.team);
      });
    }

    function determinePlayoffTeams(weeks, numTeams, teams) {
      return computeStandings(weeks, teams)
        .slice(0, numTeams)
        .map(r => r.team);
    }

    function renderStandings(rows, playoffTeams = []) {
      const table = document.getElementById('standingsTable');
      table.innerHTML = '';

      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr class="bg-gradient-to-r from-gray-700 to-gray-600">
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300 uppercase tracking-wider">Team</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">W</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">L</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">Win%</th>
          <th class="px-4 py-3 text-center text-xs font-semibold text-gray-300 uppercase tracking-wider">+/-</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'standings-row border-b border-gray-700/30';
        
        if (playoffTeams.includes(r.team)) {
          tr.classList.add('bg-green-900/20', 'playoff-glow');
        } else {
          tr.classList.add(idx % 2 === 0 ? 'bg-gray-800/20' : 'bg-gray-700/20');
        }
        
        const logo = getLogo(r.team);
        const teamCell = logo 
          ? `<div class="flex items-center gap-3"><img src="${logo}" alt="${r.team} logo" class="w-8 h-8 rounded-lg object-cover">${r.team}</div>` 
          : `<div class="flex items-center gap-3"><div class="w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center"><span class="text-xs font-bold">${r.team.charAt(0)}</span></div>${r.team}</div>`;
        
        const winPctColor = r.winPct >= 0.6 ? 'text-green-400' : r.winPct >= 0.4 ? 'text-yellow-400' : 'text-red-400';
        const pointDiffColor = r.pointDiff > 0 ? 'text-green-400' : r.pointDiff < 0 ? 'text-red-400' : 'text-gray-400';
        
        tr.innerHTML = `
          <td class="px-4 py-4 text-sm font-medium text-white">${teamCell}</td>
          <td class="px-4 py-4 text-center text-sm text-white font-semibold">${r.wins}</td>
          <td class="px-4 py-4 text-center text-sm text-white font-semibold">${r.losses}</td>
          <td class="px-4 py-4 text-center text-sm font-semibold ${winPctColor}">${r.winPct.toFixed(3)}</td>
          <td class="px-4 py-4 text-center text-sm font-semibold ${pointDiffColor}">${r.pointDiff > 0 ? '+' : ''}${r.pointDiff}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    function renderSchedule(weeks) {
      const container = document.getElementById('scheduleContainer');
      container.innerHTML = '';
      const playoffWeeks = weeks.filter(w => w.phase === 'playoffs');
      
      if (playoffWeeks.length) {
        const bracket = document.createElement('div');
        bracket.className = 'mb-8 p-6 bg-gradient-to-r from-green-900/20 to-blue-900/20 rounded-xl border border-green-500/30';
        const heading = document.createElement('h3');
        heading.className = 'text-xl font-bold text-green-400 mb-4 flex items-center gap-2';
        heading.innerHTML = `
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Playoff Bracket
        `;
        bracket.appendChild(heading);
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        playoffWeeks[0].matches.forEach(m => {
          const match = document.createElement('div');
          match.className = 'bg-gray-800/50 rounded-lg p-4 border border-gray-600/50 match-item';
          const awayLogo = getLogo(m.away);
          const homeLogo = getLogo(m.home);
          const awayLogoHtml = awayLogo ? `<img src="${awayLogo}" alt="${m.away} logo" class="w-6 h-6 rounded">` : '';
          const homeLogoHtml = homeLogo ? `<img src="${homeLogo}" alt="${m.home} logo" class="w-6 h-6 rounded">` : '';
          match.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                ${awayLogoHtml}
                <span class="font-medium">${m.away}</span>
              </div>
              <span class="text-gray-400">vs</span>
              <div class="flex items-center gap-2">
                ${homeLogoHtml}
                <span class="font-medium">${m.home}</span>
              </div>
            </div>
          `;
          grid.appendChild(match);
        });
        bracket.appendChild(grid);
        container.appendChild(bracket);
      }

      let currentPhase = 'regular';
      weeks.forEach((w, idx) => {
        const phase = w.phase || 'regular';
        if (phase !== currentPhase) {
          if (phase !== 'regular') {
            const heading = document.createElement('h3');
            heading.className = 'text-xl font-bold text-blue-400 mt-6 mb-4 flex items-center gap-2';
            const icon = phase === 'playoffs' ? 
              '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' :
              '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
            heading.innerHTML = `${icon}${phase === 'playoffs' ? 'Playoffs' : 'Championship'}`;
            container.appendChild(heading);
          }
          currentPhase = phase;
        }

        const details = document.createElement('details');
        details.className = 'mb-4 bg-gray-800/30 rounded-xl border border-gray-700/50 overflow-hidden';
        if (idx === 0) details.open = true;

        const summary = document.createElement('summary');
        summary.className = 'font-semibold cursor-pointer select-none px-6 py-4 bg-gradient-to-r from-gray-700/50 to-gray-600/50 hover:from-gray-600/50 hover:to-gray-500/50 transition-all duration-200 flex items-center gap-3';
        
        const weekIcon = document.createElement('div');
        weekIcon.className = 'w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center';
        weekIcon.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>';
        summary.appendChild(weekIcon);
        
        const weekText = document.createElement('span');
        if (phase === 'regular') {
          weekText.textContent = `Week ${w.week}`;
        } else if (phase === 'playoffs') {
          weekText.textContent = `Round ${w.week}`;
        } else {
          weekText.textContent = 'Finals';
        }
        summary.appendChild(weekText);
        
        details.appendChild(summary);

        const matchesContainer = document.createElement('div');
        matchesContainer.className = 'p-6 space-y-3';
        w.matches.forEach(m => {
          const matchDiv = document.createElement('div');
          matchDiv.className = 'bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 match-item';
          
          const score = (m.homeScore != null && m.awayScore != null) ? `${m.awayScore} - ${m.homeScore}` : '';
          const timeStr = m.time ? ` ${m.time}` : '';
          const awayLogo = getLogo(m.away);
          const homeLogo = getLogo(m.home);
          
          const awayLogoHtml = awayLogo
            ? `<img src="${awayLogo}" alt="${m.away} logo" class="w-8 h-8 rounded-lg object-cover">`
            : `<div class="w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center"><span class="text-xs font-bold">${m.away.charAt(0)}</span></div>`;
          const homeLogoHtml = homeLogo
            ? `<img src="${homeLogo}" alt="${m.home} logo" class="w-8 h-8 rounded-lg object-cover">`
            : `<div class="w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center"><span class="text-xs font-bold">${m.home.charAt(0)}</span></div>`;

          matchDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                ${awayLogoHtml}
                <div>
                  <div class="font-medium text-white">${m.away}</div>
                  <div class="text-xs text-gray-400">${m.date}${timeStr}</div>
                </div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-blue-400">@</div>
                ${score ? `<div class="text-sm text-gray-300">${score}</div>` : ''}
              </div>
              <div class="flex items-center gap-3">
                <div class="text-right">
                  <div class="font-medium text-white">${m.home}</div>
                  <div class="text-xs text-gray-400">Home</div>
                </div>
                ${homeLogoHtml}
              </div>
            </div>
          `;

          matchesContainer.appendChild(matchDiv);
        });
        details.appendChild(matchesContainer);
        container.appendChild(details);
      });
    }

    document.getElementById('lmSeason').addEventListener('change', e => loadSeasonData(e.target.value));
    document.getElementById('lmDivision').addEventListener('change', renderDivision);

    loadSeasons();
  </script>
    <script>
      async function loadNav() {
        const placeholder = document.getElementById('nav-placeholder');
        try {
          const res = await fetch('./nav.html');
          if (!res.ok) throw new Error(`Nav fetch failed: ${res.status}`);
          const html = await res.text();
          placeholder.innerHTML = html;
          placeholder.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
            newScript.textContent = oldScript.textContent;
            oldScript.replaceWith(newScript);
          });
          if (window.twitchOAuth) {
            window.twitchOAuth.updateNav();
            window.twitchOAuth.initLiveTeamsMenu();
          }
        } catch (err) {
          console.error('Failed to load navigation', err);
        }
      }
      loadNav();
    </script>
  </body>
</html>
