<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPL Standings and Matches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">
    <div id="nav-placeholder" data-include="/nav.html"></div>

  <div class="w-full max-w-4xl p-4">
    <h1 class="text-2xl font-bold text-center mb-4">TPL Standings and Matches</h1>
    <div class="flex flex-col md:flex-row gap-4 justify-center mb-6">
      <div>
        <label class="block text-sm mb-1">Season</label>
        <select id="lmSeason" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Division</label>
        <select id="lmDivision" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <section class="bg-gray-800 rounded-lg shadow-lg p-4">
        <h2 class="text-xl font-semibold mb-2">Standings</h2>
        <table id="standingsTable" class="w-full text-left text-sm"></table>
      </section>

      <section class="bg-gray-800 rounded-lg shadow-lg p-4">
        <h2 class="text-xl font-semibold mb-2">Schedule</h2>
        <div id="scheduleContainer"></div>
      </section>
    </div>
  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const staticLogos = {
      // Avalanche
      'AV': 'images/aV!.png',
      'AVALANCHE': 'images/aV!.png',
      // DPRK
      'DPRK': 'images/TeamDPRKLogo3.png',
      // Flag Pole Smokers
      'FPS': 'images/FPSlogo.png',
      'FLAGPOLESMOKERS': 'images/FPSlogo.png',
      // Flying Tractors
      'FT': 'images/FTlogo.png',
      'FLYINGTRACTORS': 'images/FTlogo.png',
      // Hegemony of Euros
      'HOE': 'images/HoE.png',
      'HEGEMONYOFEUROS': 'images/HoE.png',
      // KTL
      'KTL': 'images/KTLlogo.png',
      'KICKTOLOBBY': 'images/KTLlogo.png',
      'KICK TO LOBBY': 'images/KTLlogo.png',
      'KICKEDTOLOBBY': 'images/KTLlogo.png',
      'KICKED TO LOBBY': 'images/KTLlogo.png',
      // Magic
      'MAGIC': 'images/Magic.png',
      // TXM
      'TXM': 'images/TXM.png',
      'TEXASMILITIA': 'images/TXM.png',
      // Unhandled Exception
      'UE': 'images/UE.png',
      'UNHANDLEDEXCEPTION': 'images/UE.png',
      // Zen
      'ZEN': 'images/Zenlogo.png',
      // ePidemic
      'EPI': 'images/ePi.png',
      'EPIDEMIC': 'images/ePi.png',
      // null
      'NULL': 'images/NullLogo.png',
      // Toxic Aimers
      'TOXICAIMERS': 'images/ToxicAimersLogo.png',
      // DeadStop
      'DS': 'DeadStopLogo.png',
      'DEADSTOP': 'DeadStopLogo.png'
    };

    function normalizeName(name) {
      return name.replace(/\W/g, '').toUpperCase();
    }

    function getLogo(name) {
      const bracket = name.match(/\[(.+?)\]/);
      if (bracket) {
        const key = normalizeName(bracket[1]);
        if (teamLogos[key]) return teamLogos[key];
      }
      return teamLogos[normalizeName(name)];
    }

    let teamLogos = { ...staticLogos };
    let seasonsIndex = [];
    let currentSeasonData = null;

    async function loadSeasons() {
      const seasonSelect = document.getElementById('lmSeason');
      seasonSelect.innerHTML = '';
      const snap = await getDocs(collection(db, 'leagueSeasons'));
      seasonsIndex = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => parseInt(a.id) - parseInt(b.id));
      seasonsIndex.forEach(season => {
        const opt = document.createElement('option');
        opt.value = season.id;
        opt.textContent = `Season ${season.id}`;
        seasonSelect.appendChild(opt);
      });
      const active = seasonsIndex.find(s => s.active) || seasonsIndex[seasonsIndex.length - 1];
      if (active) {
        seasonSelect.value = active.id;
        await loadSeasonData(active.id);
      }
    }

    async function loadSeasonData(id) {
      const snap = await getDoc(doc(db, 'leagueSeasons', String(id)));
      if (!snap.exists()) return;
      currentSeasonData = snap.data();
      currentSeasonData.season = parseInt(id);
      const divisionSelect = document.getElementById('lmDivision');
      divisionSelect.innerHTML = '';
      Object.keys(currentSeasonData.divisions || {}).forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        divisionSelect.appendChild(opt);
      });
      if (divisionSelect.options.length > 0) {
        divisionSelect.value = divisionSelect.options[0].value;
      }

      await renderDivision();
    }

    async function fetchTeams(season, division) {
      const q = query(
        collection(db, 'teams'),
        where('season', '==', season),
        where('division', '==', division),
        where('approved', '==', true)
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }

    async function renderDivision() {
      const divKey = document.getElementById('lmDivision').value;
      const season = currentSeasonData.season;

      const teamDocs = await fetchTeams(season, divKey);
      const teamNames = teamDocs.map(t => t.teamName);
      teamLogos = { ...staticLogos };
      teamDocs.forEach(t => {
        if (t.logoUrl) {
          const fullKey = normalizeName(t.teamName);
          teamLogos[fullKey] = t.logoUrl;
          const bracket = t.teamName.match(/\[(.+?)\]/);
          if (bracket) {
            teamLogos[normalizeName(bracket[1])] = t.logoUrl;
          }
        }
      });

      const scheduleRef = doc(db, 'leagueSchedules', `${season}-${divKey}`);
      const snap = await getDoc(scheduleRef);
      const weeks = snap.exists() ? (snap.data().weeks || []) : [];

      const allTeams = new Set(teamNames);
      weeks.forEach(w => w.matches.forEach(m => { allTeams.add(m.home); allTeams.add(m.away); }));

      const teams = Array.from(allTeams);
      const standings = computeStandings(weeks, teams);
      const playoffTeams = determinePlayoffTeams(weeks, 4, teams);
      renderStandings(standings, playoffTeams);
      renderSchedule(weeks);
    }

    function computeStandings(weeks, teams) {
      const table = {};
      teams.forEach(t => (table[t] = { team: t, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0 }));
      weeks.forEach(w => {
        if (w.phase && w.phase !== 'regular') return;
        w.matches.forEach(m => {
          if (m.homeScore != null && m.awayScore != null) {
            table[m.home].pointsFor += m.homeScore;
            table[m.home].pointsAgainst += m.awayScore;
            table[m.away].pointsFor += m.awayScore;
            table[m.away].pointsAgainst += m.homeScore;
            if (m.homeScore > m.awayScore) {
              table[m.home].wins++;
              table[m.away].losses++;
            } else if (m.awayScore > m.homeScore) {
              table[m.away].wins++;
              table[m.home].losses++;
            }
          }
        });
      });
      return Object.values(table).map(r => {
        const games = r.wins + r.losses;
        const winPct = games ? r.wins / games : 0;
        const pointDiff = r.pointsFor - r.pointsAgainst;
        return { ...r, winPct, pointDiff };
      }).sort((a, b) => {
        if (b.winPct !== a.winPct) return b.winPct - a.winPct;
        if (b.pointDiff !== a.pointDiff) return b.pointDiff - a.pointDiff;
        return a.team.localeCompare(b.team);
      });
    }

    function determinePlayoffTeams(weeks, numTeams, teams) {
      return computeStandings(weeks, teams)
        .slice(0, numTeams)
        .map(r => r.team);
    }

    function renderStandings(rows, playoffTeams = []) {
      const table = document.getElementById('standingsTable');
      table.innerHTML = '';

      const thead = document.createElement('thead');
      thead.innerHTML = '<tr class="bg-gray-700 sticky top-0"><th class="px-2 py-1">Team</th><th class="px-2 py-1">W</th><th class="px-2 py-1">L</th><th class="px-2 py-1">Win%</th><th class="px-2 py-1">+/-</th></tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (playoffTeams.includes(r.team)) {
          tr.className = 'bg-green-800';
        } else {
          tr.className = idx % 2 === 0 ? 'bg-gray-800' : 'bg-gray-700';
        }
        const logo = getLogo(r.team);
        const teamCell = logo ? `<img src="${logo}" alt="${r.team} logo" class="w-6 h-6 inline mr-2">${r.team}` : r.team;
        tr.innerHTML = `<td class="px-2 py-1">${teamCell}</td><td class="px-2 py-1">${r.wins}</td><td class="px-2 py-1">${r.losses}</td><td class="px-2 py-1">${r.winPct.toFixed(3)}</td><td class="px-2 py-1">${r.pointDiff}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    function renderSchedule(weeks) {
      const container = document.getElementById('scheduleContainer');
      container.innerHTML = '';
      const playoffWeeks = weeks.filter(w => w.phase === 'playoffs');
      if (playoffWeeks.length) {
        const bracket = document.createElement('div');
        bracket.className = 'mb-6';
        const heading = document.createElement('h3');
        heading.className = 'text-lg font-semibold mb-2';
        heading.textContent = 'Playoff Bracket';
        bracket.appendChild(heading);
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-2 gap-4';
        playoffWeeks[0].matches.forEach(m => {
          const match = document.createElement('div');
          match.className = 'flex justify-between';
          match.innerHTML = `<span>${m.away}</span><span>${m.home}</span>`;
          grid.appendChild(match);
        });
        bracket.appendChild(grid);
        container.appendChild(bracket);
      }

      let currentPhase = 'regular';
      weeks.forEach((w, idx) => {
        const phase = w.phase || 'regular';
        if (phase !== currentPhase) {
          if (phase !== 'regular') {
            const heading = document.createElement('h3');
            heading.className = 'text-lg font-semibold mt-4 mb-2';
            heading.textContent = phase === 'playoffs' ? 'Playoffs' : 'Championship';
            container.appendChild(heading);
          }
          currentPhase = phase;
        }

        const details = document.createElement('details');
        details.className = 'mb-2 border border-gray-700 rounded';
        if (idx === 0) details.open = true;

        const summary = document.createElement('summary');
        summary.className = 'font-semibold cursor-pointer select-none px-2 py-1';
        if (phase === 'regular') {
          summary.textContent = `Week ${w.week}`;
        } else if (phase === 'playoffs') {
          summary.textContent = `Round ${w.week}`;
        } else {
          summary.textContent = 'Finals';
        }
        details.appendChild(summary);

        const ul = document.createElement('ul');
        ul.className = 'px-2 py-2 space-y-1';
        w.matches.forEach(m => {
          const li = document.createElement('li');
          li.className = 'flex items-center gap-2';
          const score = (m.homeScore != null && m.awayScore != null) ? `${m.awayScore} - ${m.homeScore}` : '';
          const timeStr = m.time ? ` ${m.time}` : '';
          const awayLogo = getLogo(m.away);
          const homeLogo = getLogo(m.home);
          const away = awayLogo ? `<img src="${awayLogo}" alt="${m.away} logo" class="w-5 h-5 mr-1">${m.away}` : m.away;
          const home = homeLogo ? `<img src="${homeLogo}" alt="${m.home} logo" class="w-5 h-5 mr-1">${m.home}` : m.home;
          li.innerHTML = `<span class="w-28 text-gray-400">${m.date}${timeStr}</span><span class="flex items-center flex-1"><span class="w-40 flex items-center justify-end gap-1 text-right">${away}</span><span class="px-1">@</span><span class="w-40 flex items-center gap-1">${home}</span></span><span class="w-12 text-right">${score}</span>`;
          ul.appendChild(li);
        });
        details.appendChild(ul);
        container.appendChild(details);
      });
    }

    document.getElementById('lmSeason').addEventListener('change', e => loadSeasonData(e.target.value));
    document.getElementById('lmDivision').addEventListener('change', renderDivision);

    loadSeasons();
  </script>
    <script>
      async function loadNav() {
        const placeholder = document.getElementById('nav-placeholder');
        try {
          const res = await fetch('./nav.html');
          if (!res.ok) throw new Error(`Nav fetch failed: ${res.status}`);
          const html = await res.text();
          placeholder.innerHTML = html;
          placeholder.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
            newScript.textContent = oldScript.textContent;
            oldScript.replaceWith(newScript);
          });
          if (window.twitchOAuth) {
            window.twitchOAuth.updateNav();
            window.twitchOAuth.initLiveTeamsMenu();
          }
        } catch (err) {
          console.error('Failed to load navigation', err);
        }
      }
      loadNav();
    </script>
  </body>
</html>
