<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player & Team Stats</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  <script src="oauth.js" defer></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="nav-placeholder" data-include="nav.html"></div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-10">
    <section class="space-y-4">
      <div>
        <h1 class="text-3xl font-bold text-white">League Player & Team Statistics</h1>
        <p class="text-gray-300">Aggregated from saved match stats. Use this page to explore how players and teams perform across every recorded match and map.</p>
      </div>
      <div id="statusMessage" class="text-sm text-gray-400">Loading match statistics…</div>
      <div id="summaryCards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"></div>
    </section>

    <section class="grid gap-8 lg:grid-cols-2" id="chartsSection" style="display:none;">
      <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-6 shadow">
        <h2 class="text-xl font-semibold text-white mb-2">Player Kills per Minute vs. Time Played</h2>
        <p class="text-sm text-gray-400 mb-4">Each point represents a player&apos;s total time played and their kills per minute across all recorded maps.</p>
        <canvas id="playerScatter" style="height:360px;"></canvas>
      </div>
      <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-6 shadow">
        <h2 class="text-xl font-semibold text-white mb-2">Team Score per Minute vs. Kills per Minute</h2>
        <p class="text-sm text-gray-400 mb-4">Compare overall team production rates. Bubble size reflects total match time recorded for the team.</p>
        <canvas id="teamScatter" style="height:360px;"></canvas>
      </div>
    </section>

    <section class="bg-gray-800/60 border border-gray-700 rounded-xl shadow">
      <header class="px-6 py-4 border-b border-gray-700">
        <h2 class="text-2xl font-semibold text-white">Player Totals</h2>
        <p class="text-sm text-gray-400">Season-long totals aggregated from every saved match.</p>
      </header>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700 text-sm">
          <thead class="bg-gray-800/80 text-gray-300 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Player</th>
              <th class="px-4 py-3 text-left">Teams</th>
              <th class="px-4 py-3 text-right">Matches</th>
              <th class="px-4 py-3 text-right">Total Time (min)</th>
              <th class="px-4 py-3 text-right">Kills</th>
              <th class="px-4 py-3 text-right">Assists</th>
              <th class="px-4 py-3 text-right">Score</th>
              <th class="px-4 py-3 text-right">Captures</th>
              <th class="px-4 py-3 text-right">Returns</th>
              <th class="px-4 py-3 text-right">KPM</th>
              <th class="px-4 py-3 text-right">APM</th>
              <th class="px-4 py-3 text-right">SPM</th>
              <th class="px-4 py-3 text-right">CPM</th>
              <th class="px-4 py-3 text-right">RPM</th>
            </tr>
          </thead>
          <tbody id="playerTotalsBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-gray-800/60 border border-gray-700 rounded-xl shadow">
      <header class="px-6 py-4 border-b border-gray-700">
        <h2 class="text-2xl font-semibold text-white">Player Map Breakdown</h2>
        <p class="text-sm text-gray-400">Track how each player performs on every map they&apos;ve played.</p>
      </header>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700 text-sm">
          <thead class="bg-gray-800/80 text-gray-300 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Player</th>
              <th class="px-4 py-3 text-left">Teams</th>
              <th class="px-4 py-3 text-left">Map</th>
              <th class="px-4 py-3 text-right">Matches</th>
              <th class="px-4 py-3 text-right">Time (min)</th>
              <th class="px-4 py-3 text-right">Kills</th>
              <th class="px-4 py-3 text-right">Assists</th>
              <th class="px-4 py-3 text-right">Score</th>
              <th class="px-4 py-3 text-right">Captures</th>
              <th class="px-4 py-3 text-right">Returns</th>
              <th class="px-4 py-3 text-right">KPM</th>
              <th class="px-4 py-3 text-right">APM</th>
              <th class="px-4 py-3 text-right">SPM</th>
              <th class="px-4 py-3 text-right">CPM</th>
              <th class="px-4 py-3 text-right">RPM</th>
            </tr>
          </thead>
          <tbody id="playerMapBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
    </section>
  </main>

  <template id="summaryCardTemplate">
    <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-4 shadow">
      <p class="text-xs uppercase tracking-wide text-indigo-300" data-label></p>
      <p class="mt-2 text-2xl font-semibold text-white" data-value></p>
      <p class="mt-1 text-sm text-gray-400" data-helper></p>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusEl = document.getElementById('statusMessage');
    const chartsSection = document.getElementById('chartsSection');
    const summaryContainer = document.getElementById('summaryCards');
    const playerTotalsBody = document.getElementById('playerTotalsBody');
    const playerMapBody = document.getElementById('playerMapBody');
    let playerChartInstance = null;
    let teamChartInstance = null;
    let pendingChartBuild = null;
    const destroyCharts = () => {
      if (playerChartInstance) {
        playerChartInstance.destroy();
        playerChartInstance = null;
      }
      if (teamChartInstance) {
        teamChartInstance.destroy();
        teamChartInstance = null;
      }
      if (pendingChartBuild !== null) {
        cancelAnimationFrame(pendingChartBuild);
        pendingChartBuild = null;
      }
    };



    const toNumber = (value) => {
      const num = parseFloat(value);
      return Number.isFinite(num) ? num : 0;
    };


    const formatTimestamp = (value) => {
      if (!value) return null;

      if (typeof value.toDate === 'function') {
        try {
          return value.toDate();
        } catch (err) {
          console.warn('Failed to convert timestamp with toDate()', err);
        }
      }

      if (typeof value.seconds === 'number') {
        const millis = value.seconds * 1000 + Math.floor((value.nanoseconds || 0) / 1_000_000);
        return new Date(millis);
      }

      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    };

    const addSummaryCard = (label, value, helper) => {
      const tpl = document.getElementById('summaryCardTemplate');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('[data-label]').textContent = label;
      node.querySelector('[data-value]').textContent = value;
      node.querySelector('[data-helper]').textContent = helper;
      summaryContainer.appendChild(node);
    };

    const formatNumber = (value, fractionDigits = 2) => {
      if (!Number.isFinite(value)) return '0';
      return value.toLocaleString(undefined, { minimumFractionDigits: fractionDigits, maximumFractionDigits: fractionDigits });
    };

    const renderTables = (playerTotals, playerMapStats) => {
      const totalsSorted = Array.from(playerTotals.values()).sort((a, b) => b.kills - a.kills);
      playerTotalsBody.innerHTML = '';
      totalsSorted.forEach(player => {
        const row = document.createElement('tr');
        const totalTime = player.time;
        const kpm = totalTime > 0 ? player.kills / totalTime : 0;
        const apm = totalTime > 0 ? player.assists / totalTime : 0;
        const spm = totalTime > 0 ? player.score / totalTime : 0;
        const cpm = totalTime > 0 ? player.captures / totalTime : 0;
        const rpm = totalTime > 0 ? player.returns / totalTime : 0;
        row.innerHTML = `
          <td class="px-4 py-3 text-left text-white">${player.name}</td>
          <td class="px-4 py-3 text-left text-gray-300">${Array.from(player.teams).join(', ') || '—'}</td>
          <td class="px-4 py-3 text-right">${player.matches}</td>
          <td class="px-4 py-3 text-right">${formatNumber(totalTime, 2)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(player.kills, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(player.assists, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(player.score, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(player.captures, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(player.returns, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(kpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(apm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(spm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(cpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(rpm)}</td>
        `;
        playerTotalsBody.appendChild(row);
      });

      const mapRows = Array.from(playerMapStats.values()).sort((a, b) => {
        if (a.player === b.player) return b.kills - a.kills;
        return a.player.localeCompare(b.player);
      });
      playerMapBody.innerHTML = '';
      mapRows.forEach(entry => {
        const totalTime = entry.time;
        const kpm = totalTime > 0 ? entry.kills / totalTime : 0;
        const apm = totalTime > 0 ? entry.assists / totalTime : 0;
        const spm = totalTime > 0 ? entry.score / totalTime : 0;
        const cpm = totalTime > 0 ? entry.captures / totalTime : 0;
        const rpm = totalTime > 0 ? entry.returns / totalTime : 0;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-4 py-3 text-left text-white">${entry.player}</td>
          <td class="px-4 py-3 text-left text-gray-300">${Array.from(entry.teams).join(', ') || '—'}</td>
          <td class="px-4 py-3 text-left text-gray-200">${entry.map}</td>
          <td class="px-4 py-3 text-right">${entry.matches}</td>
          <td class="px-4 py-3 text-right">${formatNumber(totalTime, 2)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(entry.kills, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(entry.assists, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(entry.score, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(entry.captures, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(entry.returns, 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(kpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(apm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(spm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(cpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(rpm)}</td>
        `;
        playerMapBody.appendChild(row);
      });
    };

    const renderCharts = (playerTotals, teamTotals) => {
      destroyCharts();

      const playerData = Array.from(playerTotals.values())
        .map(player => ({
          ...player,
          time: toNumber(player.time),
          kills: toNumber(player.kills),
          matches: toNumber(player.matches)
        }))
        .filter(player => player.time > 0);

      const playerPoints = playerData.map(player => ({
        x: Number(player.time.toFixed(2)),
        y: Number((player.kills / player.time).toFixed(3)),
        r: Math.max(4, Math.min(14, Math.max(1, player.matches) * 2)),
        player
      }));

      const teamData = Array.from(teamTotals.values())
        .map(team => ({
          ...team,
          time: toNumber(team.time),
          score: toNumber(team.score),
          kills: toNumber(team.kills),
          matches: toNumber(team.matches)
        }))
        .filter(team => team.time > 0);

      if (!playerPoints.length && !teamData.length) {
        chartsSection.style.display = 'none';
        return;
      }

      chartsSection.style.display = 'grid';

      const buildCharts = () => {
        pendingChartBuild = null;

        if (playerPoints.length) {
          const ctx = document.getElementById('playerScatter').getContext('2d');
          playerChartInstance = new Chart(ctx, {
            type: 'bubble',
            data: {
              datasets: [{
                label: 'Players',
                data: playerPoints.map(point => ({ x: point.x, y: point.y, r: point.r, player: point.player })),
                backgroundColor: 'rgba(129, 140, 248, 0.6)',
                borderColor: 'rgba(129, 140, 248, 1)',
                borderWidth: 1,
                hoverRadius: 0,
                hitRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              interaction: { mode: 'nearest', intersect: true },
              animations: {
                radius: { duration: 0 },
                resize: { duration: 0 }
              },
              transitions: {
                active: {
                  animation: { duration: 0 }
                }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Total Time Played (minutes)' },
                  ticks: { color: '#d1d5db' },
                  grid: { color: 'rgba(55, 65, 81, 0.5)' }
                },
                y: {
                  title: { display: true, text: 'Kills per Minute' },
                  ticks: { color: '#d1d5db' },
                  grid: { color: 'rgba(55, 65, 81, 0.5)' }
                }
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const player = context.raw.player;
                      const kpm = player.time ? player.kills / player.time : 0;
                      return [
                        `${player.name} (${Array.from(player.teams).join(', ') || 'Free Agent'})`,
                        `Time: ${formatNumber(player.time, 2)} min`,
                        `Kills: ${formatNumber(player.kills, 0)}`,
                        `KPM: ${formatNumber(kpm)}`
                      ];
                    }
                  }
                },
                legend: {
                  labels: { color: '#e5e7eb' }
                }
              }
            }
          });
        }

        if (teamData.length) {
          const ctx = document.getElementById('teamScatter').getContext('2d');
          teamChartInstance = new Chart(ctx, {
            type: 'bubble',
            data: {
              datasets: [{
                label: 'Teams',
                data: teamData.map(team => ({
                  x: Number((team.score / team.time).toFixed(3)),
                  y: Number((team.kills / team.time).toFixed(3)),
                  r: Math.max(6, Math.min(20, Math.max(1, team.time) / 10)),
                  team
                })),
                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1,
                hoverRadius: 0,
                hitRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: false,
              interaction: { mode: 'nearest', intersect: true },
              animations: {
                radius: { duration: 0 },
                resize: { duration: 0 }
              },
              transitions: {
                active: {
                  animation: { duration: 0 }
                }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Score per Minute' },
                  ticks: { color: '#d1d5db' },
                  grid: { color: 'rgba(55, 65, 81, 0.5)' }
                },
                y: {
                  title: { display: true, text: 'Kills per Minute' },
                  ticks: { color: '#d1d5db' },
                  grid: { color: 'rgba(55, 65, 81, 0.5)' }
                }
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const team = context.raw.team;
                      const spm = team.time ? team.score / team.time : 0;
                      const kpm = team.time ? team.kills / team.time : 0;
                      return [
                        `${team.name}`,
                        `Matches: ${team.matches}`,
                        `Time: ${formatNumber(team.time, 2)} min`,
                        `Score: ${formatNumber(team.score, 0)} (SPM ${formatNumber(spm)})`,
                        `Kills: ${formatNumber(team.kills, 0)} (KPM ${formatNumber(kpm)})`
                      ];
                    }
                  }
                },
                legend: {
                  labels: { color: '#e5e7eb' }
                }
              }
            }
          });
        }
      };

      pendingChartBuild = requestAnimationFrame(buildCharts);
    };
    const hydratePlayers = (entries = []) => {
      const map = new Map();
      entries.forEach(entry => {
        const teams = Array.isArray(entry.teams) ? new Set(entry.teams) : new Set();
        map.set(entry.name, { ...entry, teams });
      });
      return map;
    };

    const hydratePlayerMaps = (entries = []) => {
      const map = new Map();
      entries.forEach(entry => {
        const teams = Array.isArray(entry.teams) ? new Set(entry.teams) : new Set();
        map.set(`${entry.player}__${entry.map}`, { ...entry, teams });
      });
      return map;
    };

    const hydrateTeams = (entries = []) => {
      const map = new Map();
      entries.forEach(entry => {
        map.set(entry.name, { ...entry });
      });
      return map;
    };


    const loadPublishedStats = async () => {
      try {
        const docRef = doc(db, 'publicStats', 'aggregates');
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          statusEl.textContent = 'No published stats found. Save a match in the admin panel to generate them.';
          destroyCharts();
          chartsSection.style.display = 'none';
          summaryContainer.innerHTML = '';
          playerTotalsBody.innerHTML = '';
          playerMapBody.innerHTML = '';
          return;
        }

        const data = docSnap.data() || {};
        const playerTotals = hydratePlayers(data.playerTotals);
        const playerMapStats = hydratePlayerMaps(data.playerMapStats);
        const teamTotals = hydrateTeams(data.teamTotals);
        const totalMatches = toNumber(data.totalMatches);
        const generatedAt = formatTimestamp(data.generatedAt);

        if (playerTotals.size === 0) {
          destroyCharts();
          statusEl.textContent = 'Published stats are empty. Save a match in the admin panel to populate this dashboard.';
          chartsSection.style.display = 'none';
          summaryContainer.innerHTML = '';
          playerTotalsBody.innerHTML = '';
          playerMapBody.innerHTML = '';
          return;
        }

        summaryContainer.innerHTML = '';
        const updateHelper = generatedAt
          ? `Last updated ${generatedAt.toLocaleString()}.`
          : 'Last updated time unavailable.';
        statusEl.textContent = `Loaded ${totalMatches} match${totalMatches === 1 ? '' : 'es'} worth of statistics. ${updateHelper}`;

        addSummaryCard('Matches Processed', totalMatches, 'Matches included in this report.');
        addSummaryCard('Total Players', playerTotals.size, 'Unique players with recorded stats.');
        addSummaryCard('Total Teams', teamTotals.size, 'Teams represented across all matches.');
        const totalMinutes = Array.from(playerTotals.values()).reduce((sum, p) => sum + toNumber(p.time), 0);
        addSummaryCard('Minutes Tracked', formatNumber(totalMinutes, 2), 'Combined playtime from every player.');
        const totalKills = Array.from(playerTotals.values()).reduce((sum, p) => sum + toNumber(p.kills), 0);
        addSummaryCard('Total Kills Logged', formatNumber(totalKills, 0), 'All kills recorded in the database.');

        renderTables(playerTotals, playerMapStats);
        renderCharts(playerTotals, teamTotals);
      } catch (err) {
        console.error(err);
        destroyCharts();
        statusEl.textContent = 'Unable to load stats. Please refresh to try again.';
        chartsSection.style.display = 'none';
      }
    };

    loadPublishedStats();
    </script>
  <script src="./assets/include.js" defer></script>
</body>
</html>

