<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Player & Team Stats</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" defer></script>
  <script src="oauth.js" defer></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="nav-placeholder" data-include="nav.html"></div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-10">
    <section class="space-y-4">
      <div>
        <h1 class="text-3xl font-bold text-white">League Player & Team Statistics</h1>
        <p class="text-gray-300">Aggregated from saved match stats. Use this page to explore how players and teams perform across every recorded match and map.</p>
      </div>
      <div id="statusMessage" class="text-sm text-gray-400">Loading match statistics.</div>
      <div id="summaryCards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"></div>
    </section>

    <section class="space-y-8" id="chartsSection" style="display:none;">
      <div id="perMinuteSection" class="space-y-4">
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="text-xl font-semibold text-white">Player Production Rates</h2>
          <div id="perMinuteTabs" class="flex flex-wrap gap-2"></div>
        </div>
        <p class="text-sm text-gray-400">Per-minute outputs across all recorded matches.</p>
        <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-6 shadow">
          <div class="overflow-x-auto">
            <canvas id="perMinuteChart" style="height:320px;"></canvas>
          </div>
        </div>
      </div>

      <div id="killShareSection" class="space-y-4">
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="text-xl font-semibold text-white">Kill Share by Team</h2>
          <select id="killShareSelect" class="bg-gray-900 border border-gray-700 text-gray-100 rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
        </div>
        <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-6 shadow">
          <canvas id="killShareChart" style="height:300px;"></canvas>
        </div>
      </div>

      <div id="leaderboardSection" class="space-y-4">
        <h2 class="text-xl font-semibold text-white">Best Performers</h2>
        <p class="text-sm text-gray-400">Top players across core efficiency metrics.</p>
        <div id="leaderboardCards" class="grid gap-6 md:grid-cols-2 xl:grid-cols-3"></div>
      </div>
    </section>

    <section class="bg-gray-800/60 border border-gray-700 rounded-xl shadow">
      <header class="px-6 py-4 border-b border-gray-700">
        <h2 class="text-2xl font-semibold text-white">Player Totals</h2>
        <p class="text-sm text-gray-400">Season-long totals aggregated from every saved match.</p>
      </header>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700 text-sm">
          <thead class="bg-gray-800/80 text-gray-300 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Player</th>
              <th class="px-4 py-3 text-left">Teams</th>
              <th class="px-4 py-3 text-right">Matches</th>
              <th class="px-4 py-3 text-right">Total Time (min)</th>
              <th class="px-4 py-3 text-right">Kills</th>
              <th class="px-4 py-3 text-right">Assists</th>
              <th class="px-4 py-3 text-right">Score</th>
              <th class="px-4 py-3 text-right">Captures</th>
              <th class="px-4 py-3 text-right">Returns</th>
              <th class="px-4 py-3 text-right">KPM</th>
              <th class="px-4 py-3 text-right">APM</th>
              <th class="px-4 py-3 text-right">SPM</th>
              <th class="px-4 py-3 text-right">CPM</th>
              <th class="px-4 py-3 text-right">RPM</th>
            </tr>
          </thead>
          <tbody id="playerTotalsBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-gray-800/60 border border-gray-700 rounded-xl shadow">
      <header class="px-6 py-4 border-b border-gray-700">
        <h2 class="text-2xl font-semibold text-white">Player Map Breakdown</h2>
        <p class="text-sm text-gray-400">Track how each player performs on every map they've played.</p>
      </header>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-700 text-sm">
          <thead class="bg-gray-800/80 text-gray-300 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Player</th>
              <th class="px-4 py-3 text-left">Teams</th>
              <th class="px-4 py-3 text-left">Map</th>
              <th class="px-4 py-3 text-right">Matches</th>
              <th class="px-4 py-3 text-right">Time (min)</th>
              <th class="px-4 py-3 text-right">Kills</th>
              <th class="px-4 py-3 text-right">Assists</th>
              <th class="px-4 py-3 text-right">Score</th>
              <th class="px-4 py-3 text-right">Captures</th>
              <th class="px-4 py-3 text-right">Returns</th>
              <th class="px-4 py-3 text-right">KPM</th>
              <th class="px-4 py-3 text-right">APM</th>
              <th class="px-4 py-3 text-right">SPM</th>
              <th class="px-4 py-3 text-right">CPM</th>
              <th class="px-4 py-3 text-right">RPM</th>
            </tr>
          </thead>
          <tbody id="playerMapBody" class="divide-y divide-gray-800"></tbody>
        </table>
      </div>
    </section>
  </main>

  <template id="summaryCardTemplate">
    <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-4 shadow">
      <p class="text-xs uppercase tracking-wide text-indigo-300" data-label></p>
      <p class="mt-2 text-2xl font-semibold text-white" data-value></p>
      <p class="mt-1 text-sm text-gray-400" data-helper></p>
    </div>
  </template>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM',
      authDomain: 'team-sign-up-b5646.firebaseapp.com',
      projectId: 'team-sign-up-b5646',
      storageBucket: 'team-sign-up-b5646.firebasestorage.app',
      messagingSenderId: '951471144681',
      appId: '1:951471144681:web:a2458675ce73ce9ad9ba78'
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusEl = document.getElementById('statusMessage');
    const chartsSection = document.getElementById('chartsSection');
    const perMinuteSection = document.getElementById('perMinuteSection');
    const perMinuteTabs = document.getElementById('perMinuteTabs');
    const perMinuteChartCanvas = document.getElementById('perMinuteChart');
    const killShareSection = document.getElementById('killShareSection');
    const killShareSelect = document.getElementById('killShareSelect');
    const killShareChartCanvas = document.getElementById('killShareChart');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const leaderboardCardsContainer = document.getElementById('leaderboardCards');
    const summaryContainer = document.getElementById('summaryCards');
    const playerTotalsBody = document.getElementById('playerTotalsBody');
    const playerMapBody = document.getElementById('playerMapBody');

    const chartInstances = new Map();
    let pendingChartBuild = null;

    const destroyCharts = () => {
      chartInstances.forEach(chart => chart.destroy());
      chartInstances.clear();
      if (pendingChartBuild !== null) {
        cancelAnimationFrame(pendingChartBuild);
        pendingChartBuild = null;
      }
    };

    const toNumber = (value) => {
      const num = parseFloat(value);
      return Number.isFinite(num) ? num : 0;
    };

    const formatTimestamp = (value) => {
      if (!value) return null;
      if (typeof value.toDate === 'function') {
        try {
          return value.toDate();
        } catch (err) {
          console.warn('Failed to convert timestamp with toDate()', err);
        }
      }
      if (typeof value.seconds === 'number') {
        const millis = value.seconds * 1000 + Math.floor((value.nanoseconds || 0) / 1_000_000);
        return new Date(millis);
      }
      const parsed = new Date(value);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    };

    const addSummaryCard = (label, value, helper) => {
      const tpl = document.getElementById('summaryCardTemplate');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('[data-label]').textContent = label;
      node.querySelector('[data-value]').textContent = value;
      node.querySelector('[data-helper]').textContent = helper;
      summaryContainer.appendChild(node);
    };

    const formatNumber = (value, fractionDigits = 2) => {
      if (!Number.isFinite(value)) return '0';
      return value.toLocaleString(undefined, {
        minimumFractionDigits: fractionDigits,
        maximumFractionDigits: fractionDigits
      });
    };

    const chartPalette = ['#6366F1', '#EC4899', '#F59E0B', '#10B981', '#38BDF8', '#F97316', '#14B8A6', '#8B5CF6'];
    const safeDivide = (numerator, denominator) => (denominator > 0 ? numerator / denominator : 0);
    const formatPercent = (value, fractionDigits = 1) => `${formatNumber(value * 100, fractionDigits)}%`;

    const buildPlayerMetrics = (playerTotals) => {
      return Array.from(playerTotals.values())
        .map(player => {
          const time = toNumber(player.time);
          const kills = toNumber(player.kills);
          const assists = toNumber(player.assists);
          const score = toNumber(player.score);
          const captures = toNumber(player.captures);
          const returns = toNumber(player.returns);
          const matches = toNumber(player.matches);
          const teams = player.teams instanceof Set
            ? new Set(player.teams)
            : new Set(Array.isArray(player.teams) ? player.teams : (player.team ? [player.team] : []));
          return {
            ...player,
            teams,
            time,
            kills,
            assists,
            score,
            captures,
            returns,
            matches,
            scorePerMinute: safeDivide(score, time),
            killsPerMinute: safeDivide(kills, time),
            assistsPerMinute: safeDivide(assists, time),
            capturesPerMinute: safeDivide(captures, time),
            returnsPerMinute: safeDivide(returns, time)
          };
        })
        .filter(player => player.time > 0);
    };

    const renderTables = (playerTotals, playerMapStats) => {
      const totalsSorted = Array.from(playerTotals.values()).sort((a, b) => b.kills - a.kills);
      playerTotalsBody.innerHTML = '';
      totalsSorted.forEach(player => {
        const row = document.createElement('tr');
        const totalTime = toNumber(player.time);
        const kpm = totalTime > 0 ? toNumber(player.kills) / totalTime : 0;
        const apm = totalTime > 0 ? toNumber(player.assists) / totalTime : 0;
        const spm = totalTime > 0 ? toNumber(player.score) / totalTime : 0;
        const cpm = totalTime > 0 ? toNumber(player.captures) / totalTime : 0;
        const rpm = totalTime > 0 ? toNumber(player.returns) / totalTime : 0;
        row.innerHTML = `
          <td class="px-4 py-3 text-left text-white">${player.name}</td>
          <td class="px-4 py-3 text-left text-gray-300">${Array.from(player.teams || []).join(', ') || '-'}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(player.matches), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(totalTime, 2)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(player.kills), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(player.assists), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(player.score), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(player.captures), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(player.returns), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(kpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(apm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(spm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(cpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(rpm)}</td>
        `;
        playerTotalsBody.appendChild(row);
      });

      const mapRows = Array.from(playerMapStats.values()).sort((a, b) => {
        if (a.player === b.player) return toNumber(b.kills) - toNumber(a.kills);
        return a.player.localeCompare(b.player);
      });
      playerMapBody.innerHTML = '';
      mapRows.forEach(entry => {
        const totalTime = toNumber(entry.time);
        const kpm = totalTime > 0 ? toNumber(entry.kills) / totalTime : 0;
        const apm = totalTime > 0 ? toNumber(entry.assists) / totalTime : 0;
        const spm = totalTime > 0 ? toNumber(entry.score) / totalTime : 0;
        const cpm = totalTime > 0 ? toNumber(entry.captures) / totalTime : 0;
        const rpm = totalTime > 0 ? toNumber(entry.returns) / totalTime : 0;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-4 py-3 text-left text-white">${entry.player}</td>
          <td class="px-4 py-3 text-left text-gray-300">${Array.from(entry.teams || []).join(', ') || '-'}</td>
          <td class="px-4 py-3 text-left text-gray-200">${entry.map}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(entry.matches), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(totalTime, 2)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(entry.kills), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(entry.assists), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(entry.score), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(entry.captures), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(toNumber(entry.returns), 0)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(kpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(apm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(spm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(cpm)}</td>
          <td class="px-4 py-3 text-right">${formatNumber(rpm)}</td>
        `;
        playerMapBody.appendChild(row);
      });
    };

    const renderPerMinuteCharts = (playerMetrics) => {
      if (!perMinuteSection || !perMinuteTabs || !perMinuteChartCanvas) return 0;

      const metricDefinitions = [
        { id: 'scorePerMinute', key: 'scorePerMinute', label: 'Score Per Minute', helper: 'Per-minute scoring output.', color: chartPalette[0], totalKey: 'score' },
        { id: 'killsPerMinute', key: 'killsPerMinute', label: 'Kills Per Minute', helper: 'Eliminations efficiency.', color: chartPalette[1], totalKey: 'kills' },
        { id: 'assistsPerMinute', key: 'assistsPerMinute', label: 'Assists Per Minute', helper: 'Support provided per minute.', color: chartPalette[2], totalKey: 'assists' },
        { id: 'capturesPerMinute', key: 'capturesPerMinute', label: 'Captures Per Minute', helper: 'Flag captures per minute.', color: chartPalette[3], totalKey: 'captures' },
        { id: 'returnsPerMinute', key: 'returnsPerMinute', label: 'Returns Per Minute', helper: 'Flag returns per minute.', color: chartPalette[4], totalKey: 'returns' }
      ];

      const metricData = metricDefinitions
        .map(def => {
          const players = playerMetrics.slice().sort((a, b) => b[def.key] - a[def.key]);
          return { ...def, players };
        })
        .filter(metric => metric.players.length > 0);

      if (!metricData.length) {
        perMinuteSection.style.display = 'none';
        const existing = chartInstances.get('per-minute');
        if (existing) existing.destroy();
        chartInstances.delete('per-minute');
        return 0;
      }

      perMinuteTabs.innerHTML = '';
      const ctx = perMinuteChartCanvas.getContext('2d');
      const activateTab = (metricId) => {
        perMinuteTabs.querySelectorAll('button').forEach(button => {
          const isActive = button.dataset.metricId === metricId;
          button.className = isActive
            ? 'px-3 py-1 text-sm rounded bg-indigo-600 text-white shadow'
            : 'px-3 py-1 text-sm rounded bg-gray-800 text-gray-300 hover:bg-gray-700';
        });
      };

      const renderMetricChart = (metric) => {
        const existing = chartInstances.get('per-minute');
        if (existing) existing.destroy();

        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: metric.players.map(player => player.name),
            datasets: [{
              label: metric.label,
              data: metric.players.map(player => Number(player[metric.key].toFixed(3))),
              backgroundColor: metric.players.map((_, idx) => chartPalette[idx % chartPalette.length])
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            indexAxis: 'x',
            interaction: { mode: 'nearest', intersect: true },
            scales: {
              x: { beginAtZero: true, ticks: { color: '#d1d5db' }, grid: { color: 'rgba(55, 65, 81, 0.5)' } },
              y: { ticks: { color: '#d1d5db' }, grid: { display: false } }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const player = metric.players[context.dataIndex];
                    return [`${context.label}: ${formatNumber(context.raw, 2)} per min`, `${metric.totalKey.replace(/([A-Z])/g, ' $1').trim()}: ${formatNumber(player[metric.totalKey], 0)}`];
                  }
                }
              }
            }
          }
        });

        chartInstances.set('per-minute', chart);
        activateTab(metric.id);
      };

      metricData.forEach((metric, idx) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.dataset.metricId = metric.id;
        button.className = idx === 0
          ? 'px-3 py-1 text-sm rounded bg-indigo-600 text-white shadow'
          : 'px-3 py-1 text-sm rounded bg-gray-800 text-gray-300 hover:bg-gray-700';
        button.textContent = metric.label;
        button.addEventListener('click', () => renderMetricChart(metric));
        perMinuteTabs.appendChild(button);
      });

      renderMetricChart(metricData[0]);
      perMinuteSection.style.display = 'block';
      return 1;
    };

    const renderKillShareCharts = (playerMetrics) => {
      if (!killShareSection || !killShareSelect || !killShareChartCanvas) return 0;

      const teamMap = new Map();
      playerMetrics.forEach(player => {
        if (!player.teams || !player.teams.size) return;
        player.teams.forEach(teamName => {
          if (!teamName) return;
          const entry = teamMap.get(teamName) || { name: teamName, players: [] };
          entry.players.push({ name: player.name, kills: player.kills });
          teamMap.set(teamName, entry);
        });
      });

      const teams = Array.from(teamMap.values())
        .map(entry => {
          const players = entry.players.filter(player => player.kills > 0).sort((a, b) => b.kills - a.kills);
          const totalKills = players.reduce((sum, player) => sum + player.kills, 0);
          return { ...entry, players, totalKills };
        })
        .filter(entry => entry.totalKills > 0)
        .sort((a, b) => b.totalKills - a.totalKills);

      const existing = chartInstances.get('kill-share');
      if (existing) {
        existing.destroy();
        chartInstances.delete('kill-share');
      }

      if (!teams.length) {
        killShareSection.style.display = 'none';
        killShareSelect.innerHTML = '';
        return 0;
      }

      killShareSelect.innerHTML = '';
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.name;
        option.textContent = `${team.name} (${formatNumber(team.totalKills, 0)} kills)`;
        killShareSelect.appendChild(option);
      });

      const ctx = killShareChartCanvas.getContext('2d');

      const renderTeamChart = (team) => {
        const existingChart = chartInstances.get('kill-share');
        if (existingChart) existingChart.destroy();

        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: team.players.map(player => player.name),
            datasets: [{
              data: team.players.map(player => player.kills),
              backgroundColor: team.players.map((_, idx) => chartPalette[idx % chartPalette.length]),
              borderColor: '#1f2937',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#d1d5db' }
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const kills = context.raw;
                    const percent = kills / team.totalKills;
                    return `${context.label}: ${formatNumber(kills, 0)} kills (${formatPercent(percent)})`;
                  }
                }
              }
            }
          }
        });

        chartInstances.set('kill-share', chart);
      };

      killShareSelect.value = teams[0].name;
      renderTeamChart(teams[0]);

      killShareSelect.onchange = () => {
        const team = teams.find(t => t.name === killShareSelect.value);
        if (team) renderTeamChart(team);
      };

      killShareSection.style.display = 'block';
      return 1;
    };

    const renderLeaderboards = (playerMetrics) => {
      if (!leaderboardSection || !leaderboardCardsContainer) return 0;
      leaderboardCardsContainer.innerHTML = '';
      const metrics = [
        { key: 'scorePerMinute', label: 'Score Per Minute', helper: 'Highest scoring efficiency.' },
        { key: 'killsPerMinute', label: 'Kills Per Minute', helper: 'Fastest eliminations.' },
        { key: 'assistsPerMinute', label: 'Assists Per Minute', helper: 'Most team support.' },
        { key: 'capturesPerMinute', label: 'Captures Per Minute', helper: 'Flag capture specialists.' },
        { key: 'returnsPerMinute', label: 'Returns Per Minute', helper: 'Flag return specialists.' }
      ];
      let cardCount = 0;

      metrics.forEach(metric => {
        const leaders = playerMetrics
          .filter(player => player[metric.key] > 0)
          .sort((a, b) => b[metric.key] - a[metric.key])
          .slice(0, 5);
        if (!leaders.length) return;

        const listItems = leaders
          .map((player, idx) => `<li class="flex justify-between text-sm text-gray-300"><span>${idx + 1}. ${player.name}</span><span>${formatNumber(player[metric.key], 2)} / min</span></li>`)
          .join('');

        const card = document.createElement('div');
        card.className = 'bg-gray-800/60 border border-gray-700 rounded-xl p-5 shadow space-y-3';
        card.innerHTML = `
          <p class="text-xs uppercase tracking-wide text-indigo-300">${metric.label}</p>
          <p class="text-xs text-gray-400">${metric.helper}</p>
          <ol class="space-y-1">${listItems}</ol>
        `;
        leaderboardCardsContainer.appendChild(card);
        cardCount += 1;
      });

      leaderboardSection.style.display = cardCount ? 'block' : 'none';
      return cardCount;
    };

    const renderCharts = (playerMetrics) => {
      destroyCharts();
      const perMinuteCount = renderPerMinuteCharts(playerMetrics);
      if (perMinuteSection) perMinuteSection.style.display = perMinuteCount ? 'block' : 'none';
      const killShareCount = renderKillShareCharts(playerMetrics);
      if (killShareSection) killShareSection.style.display = killShareCount ? 'block' : 'none';
      const leaderboardCount = renderLeaderboards(playerMetrics);
      if (leaderboardSection) leaderboardSection.style.display = leaderboardCount ? 'block' : 'none';
      const shouldShow = (perMinuteCount + killShareCount + leaderboardCount) > 0;
      chartsSection.style.display = shouldShow ? 'block' : 'none';
    };

    const hydratePlayers = (entries = []) => {
      const map = new Map();
      entries.forEach(entry => {
        const teams = Array.isArray(entry.teams) ? new Set(entry.teams) : new Set(entry.team ? [entry.team] : []);
        map.set(entry.name, { ...entry, teams });
      });
      return map;
    };

    const hydratePlayerMaps = (entries = []) => {
      const map = new Map();
      entries.forEach(entry => {
        const teams = Array.isArray(entry.teams) ? new Set(entry.teams) : new Set();
        map.set(`${entry.player}__${entry.map}`, { ...entry, teams });
      });
      return map;
    };

    const hydrateTeams = (entries = []) => {
      const map = new Map();
      entries.forEach(entry => {
        map.set(entry.name, { ...entry });
      });
      return map;
    };

    const loadPublishedStats = async () => {
      try {
        const docRef = doc(db, 'publicStats', 'aggregates');
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          statusEl.textContent = 'No published stats found. Save a match in the admin panel to generate them.';
          destroyCharts();
          chartsSection.style.display = 'none';
          summaryContainer.innerHTML = '';
          playerTotalsBody.innerHTML = '';
          playerMapBody.innerHTML = '';
          return;
        }

        const data = docSnap.data() || {};
        const playerTotals = hydratePlayers(data.playerTotals || []);
        const playerMapStats = hydratePlayerMaps(data.playerMapStats || []);
        const teamTotals = hydrateTeams(data.teamTotals || []);
        const playerMetrics = buildPlayerMetrics(playerTotals);
        const totalMatches = toNumber(data.totalMatches);
        const generatedAt = formatTimestamp(data.generatedAt);

        if (playerTotals.size === 0) {
          statusEl.textContent = 'Published stats are empty. Save a match in the admin panel to populate this dashboard.';
          destroyCharts();
          chartsSection.style.display = 'none';
          summaryContainer.innerHTML = '';
          playerTotalsBody.innerHTML = '';
          playerMapBody.innerHTML = '';
          return;
        }

        summaryContainer.innerHTML = '';
        const updateHelper = generatedAt
          ? `Last updated ${generatedAt.toLocaleString()}.`
          : 'Last updated time unavailable.';
        statusEl.textContent = `Loaded ${totalMatches} match${totalMatches === 1 ? '' : 'es'} worth of statistics. ${updateHelper}`;

        addSummaryCard('Matches Processed', totalMatches, 'Matches included in this report.');
        addSummaryCard('Total Players', playerTotals.size, 'Unique players with recorded stats.');
        addSummaryCard('Total Teams', teamTotals.size, 'Teams represented across all matches.');
        const totalMinutes = Array.from(playerTotals.values()).reduce((sum, p) => sum + toNumber(p.time), 0);
        addSummaryCard('Minutes Tracked', formatNumber(totalMinutes, 2), 'Combined playtime from every player.');
        const totalKills = Array.from(playerTotals.values()).reduce((sum, p) => sum + toNumber(p.kills), 0);
        addSummaryCard('Total Kills Logged', formatNumber(totalKills, 0), 'All kills recorded in the database.');

        renderTables(playerTotals, playerMapStats);
        renderCharts(playerMetrics);
      } catch (err) {
        console.error(err);
        destroyCharts();
        statusEl.textContent = 'Unable to load stats. Please refresh to try again.';
        chartsSection.style.display = 'none';
      }
    };

    loadPublishedStats();
  </script>
  <script src="./assets/include.js" defer></script>
</body>
</html>


