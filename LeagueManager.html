<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPL League Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">
  <div id="nav-placeholder" data-include="/nav.html"></div>


  <div id="loginDiv" class="max-w-sm mx-auto mt-10 space-y-4">
    <h1 class="text-2xl font-bold text-center">Admin Login</h1>
    <input id="email" type="email" placeholder="Email" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <button id="loginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded">Login</button>
  </div>

  <div id="adminPanel" class="hidden w-full max-w-5xl p-4">
    <div class="flex justify-end mb-4">
      <button id="logoutBtn" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded">Logout</button>
    </div>
    <h1 class="text-2xl font-bold text-center mb-4">League Manager</h1>
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <div>
        <label class="block text-sm mb-1">Season</label>
        <div class="flex gap-2">
          <select id="lmSeason" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
          <button id="addSeason" class="px-2 py-1 bg-blue-600 rounded">+</button>
          <button id="deleteSeason" class="px-2 py-1 bg-red-600 rounded">&#x2212;</button>
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">Division</label>
        <select id="lmDivision" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Weeks</label>
        <div class="flex gap-2">
          <input id="weekCount" type="number" min="1" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600 w-20">
          <button id="generateWeeks" class="px-3 py-2 bg-indigo-600 rounded-md text-white">Generate</button>
        </div>
      </div>
    </div>

    <div id="weeksContainer" class="space-y-6"></div>

    <button id="saveSchedule" class="mt-6 px-4 py-2 bg-green-600 rounded-md">Save Schedule</button>

    <div id="standingsSection" class="mt-10">
      <h2 class="text-xl font-semibold mb-2">Standings</h2>
      <table id="standingsTable" class="min-w-full text-left"></table>
    </div>
    <h1 class="text-3xl font-bold mt-12">Manage Teams</h1>
    <ul id="teamList" class="space-y-2 mt-4"></ul>
  </div>

  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-4 rounded w-full max-w-xl">
      <h2 class="text-xl mb-4">Edit Team</h2>
      <form id="editForm" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Team Name</label>
          <input id="editTeamName" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600">
        </div>
        <div>
          <label class="block text-sm mb-1">Team Tag</label>
          <input id="editTeamTag" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600">
        </div>
        <div class="flex gap-2">
          <div class="flex-1">
            <label class="block text-sm mb-1">Season</label>
            <select id="editSeason" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600"></select>
          </div>
          <div class="flex-1">
            <label class="block text-sm mb-1">Division</label>
            <select id="editDivision" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600"></select>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Roster</label>
          <table class="w-full text-left" id="rosterTable">
            <thead><tr><th class="px-2">Name</th><th class="px-2">Twitch</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <button type="button" id="addPlayer" class="mt-2 px-2 py-1 bg-blue-600 rounded">Add Player</button>
        </div>
        <div>
          <label class="block text-sm mb-1">Bench</label>
          <input id="editBench" class="w-full px-2 py-1 rounded bg-gray-700 border border-gray-600" placeholder="Comma separated">
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelEdit" class="px-3 py-1 bg-gray-600 rounded">Cancel</button>
          <button type="submit" class="px-3 py-1 bg-green-600 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
    authDomain: "team-sign-up-b5646.firebaseapp.com",
    projectId: "team-sign-up-b5646",
    storageBucket: "team-sign-up-b5646.firebasestorage.app",
    messagingSenderId: "951471144681",
    appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  let seasonsIndex = [];
  let currentSeasonData = null;
  let teams = [];

  const loginDiv = document.getElementById('loginDiv');
  const adminPanel = document.getElementById('adminPanel');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const editModal = document.getElementById('editModal');
  const editForm = document.getElementById('editForm');
  const cancelEdit = document.getElementById('cancelEdit');
  const rosterTableBody = document.querySelector('#rosterTable tbody');
  const addPlayerBtn = document.getElementById('addPlayer');
  let currentEditId = null;

  function addPlayerRow(name = '', twitch = '') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="px-2 py-1"><input class="player-name w-full px-2 py-1 rounded bg-gray-700 border border-gray-600" value="${name}"></td>
      <td class="px-2 py-1"><input class="player-twitch w-full px-2 py-1 rounded bg-gray-700 border border-gray-600" value="${twitch}"></td>
      <td class="px-2 py-1 text-right"><button type="button" class="remove-player px-2 py-1 bg-red-600 rounded">X</button></td>
    `;
    tr.querySelector('.remove-player').addEventListener('click', () => tr.remove());
    rosterTableBody.appendChild(tr);
  }

  function fillDivisionOptions(seasonId, selected) {
    const season = seasonsIndex.find(s => s.id == seasonId);
    const divSel = document.getElementById('editDivision');
    divSel.innerHTML = '';
    if (season && season.divisions) {
      Object.keys(season.divisions).forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        if (d === selected) opt.selected = true;
        divSel.appendChild(opt);
      });
    }
  }

  function openEditModal(data) {
    document.getElementById('editTeamName').value = data.teamName || '';
    document.getElementById('editTeamTag').value = data.teamTag || '';
    const seasonSel = document.getElementById('editSeason');
    seasonSel.innerHTML = '';
    seasonsIndex.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = `Season ${s.id}`;
      seasonSel.appendChild(opt);
    });
    seasonSel.value = data.season;
    fillDivisionOptions(data.season, data.division);
    rosterTableBody.innerHTML = '';
    if (data.players && data.players.length) {
      data.players.forEach(p => addPlayerRow(p.name, p.twitch || ''));
    } else {
      addPlayerRow();
    }
    document.getElementById('editBench').value = (data.benchPlayers || []).join(', ');
    editModal.classList.remove('hidden');
  }

  function closeEditModal() {
    editModal.classList.add('hidden');
    currentEditId = null;
    rosterTableBody.innerHTML = '';
  }

  addPlayerBtn.addEventListener('click', () => addPlayerRow());
  cancelEdit.addEventListener('click', closeEditModal);
  document.getElementById('editSeason').addEventListener('change', e => fillDivisionOptions(e.target.value));
  editForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentEditId) return;
    const teamName = document.getElementById('editTeamName').value.trim();
    const teamTag = document.getElementById('editTeamTag').value.trim();
    const season = parseInt(document.getElementById('editSeason').value, 10);
    const division = document.getElementById('editDivision').value;
    const players = Array.from(rosterTableBody.querySelectorAll('tr')).map(tr => {
      const name = tr.querySelector('.player-name').value.trim();
      const twitch = tr.querySelector('.player-twitch').value.trim();
      return name ? { name, twitch } : null;
    }).filter(Boolean);
    const benchPlayers = document.getElementById('editBench').value.split(',').map(p => p.trim()).filter(Boolean);
    await updateDoc(doc(db, 'teams', currentEditId), { teamName, teamTag, season, division, players, benchPlayers });
    closeEditModal();
    loadTeams();
  });

  loginBtn.addEventListener('click', () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
  });

  logoutBtn.addEventListener('click', () => signOut(auth));

  onAuthStateChanged(auth, user => {
    if (user) {
      loginDiv.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      loadSeasons();
      loadTeams();
    } else {
      adminPanel.classList.add('hidden');
      loginDiv.classList.remove('hidden');
    }
  });

  async function loadSeasons() {
    const seasonSelect = document.getElementById('lmSeason');
    seasonSelect.innerHTML = '';
    const snap = await getDocs(collection(db, 'leagueSeasons'));
    seasonsIndex = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .sort((a, b) => parseInt(a.id) - parseInt(b.id));
    seasonsIndex.forEach(season => {
      const opt = document.createElement('option');
      opt.value = season.id;
      opt.textContent = `Season ${season.id}`;
      seasonSelect.appendChild(opt);
    });
    const active = seasonsIndex.find(s => s.active) || seasonsIndex[seasonsIndex.length - 1];
    if (active) {
      seasonSelect.value = active.id;
      await loadSeasonData(active.id);
    }
  }

  async function loadSeasonData(id) {
    const snap = await getDoc(doc(db, 'leagueSeasons', String(id)));
    if (!snap.exists()) return;
    currentSeasonData = snap.data();
    currentSeasonData.season = parseInt(id);
    const divisionSelect = document.getElementById('lmDivision');
    divisionSelect.innerHTML = '';
    Object.keys(currentSeasonData.divisions || {}).forEach(div => {
      const opt = document.createElement('option');
      opt.value = div;
      opt.textContent = div;
      divisionSelect.appendChild(opt);
    });
    if (divisionSelect.options.length > 0) {
      divisionSelect.value = divisionSelect.options[0].value;
    }
    await loadApprovedTeams();
    await loadSchedule();
  }

  async function loadApprovedTeams() {
    const season = currentSeasonData.season;
    const division = document.getElementById('lmDivision').value;
    const q = query(
      collection(db, 'teams'),
      where('season', '==', season),
      where('division', '==', division),
      where('approved', '==', true)
    );
    const snap = await getDocs(q);
    teams = snap.docs.map(d => d.data().teamName).sort();
  }

  async function loadTeams() {
    const list = document.getElementById('teamList');
    list.innerHTML = '';
    const snap = await getDocs(collection(db, 'teams'));
    snap.forEach(docSnap => {
      const data = docSnap.data();
      const li = document.createElement('li');
      li.className = 'bg-gray-800 p-3 rounded flex justify-between items-center';
      const players = (data.players || []).map(p => p.name).join(', ');
      const bench = (data.benchPlayers || []).join(', ');
      li.innerHTML = `
        <div>
          <strong>${data.teamName} [${data.teamTag}]</strong> - Season ${data.season} ${data.division}<br>
          Players: ${players}${bench ? `<br>Bench: ${bench}` : ''}
        </div>
        <span>
          <button data-id="${docSnap.id}" data-approved="${data.approved}" class="team-approve bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded mr-2">${data.approved ? 'Unapprove' : 'Approve'}</button>
          <button data-id="${docSnap.id}" class="team-edit bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded mr-2">Edit</button>
          <button data-id="${docSnap.id}" class="team-delete bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Delete</button>
        </span>`;
      list.appendChild(li);
    });

    list.querySelectorAll('.team-delete').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      await deleteDoc(doc(db, 'teams', id));
      loadTeams();
    }));

    list.querySelectorAll('.team-approve').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      const approved = e.target.dataset.approved === 'true';
      await updateDoc(doc(db, 'teams', id), { approved: !approved });
      loadTeams();
    }));

    list.querySelectorAll('.team-edit').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      const docRef = doc(db, 'teams', id);
      const snap = await getDoc(docRef);
      if (!snap.exists()) return;
      currentEditId = id;
      openEditModal(snap.data());
    }));
  }

  function createTeamSelect(selected) {
    const sel = document.createElement('select');
    sel.className = 'px-2 py-1 rounded bg-gray-800 border border-gray-700';
    teams.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      if (t === selected) opt.selected = true;
      sel.appendChild(opt);
    });
    return sel;
  }

  function pairKey(a, b) {
    return [a, b].sort().join('|');
  }

  function getUsedPairs(currentWeek, excludeRow) {
    const used = new Set();
    document.querySelectorAll('#weeksContainer > div').forEach(div => {
      const w = Number(div.dataset.week);
      const phase = div.dataset.phase || 'regular';
      if (phase !== 'regular') return;
      div.querySelectorAll('.flex.flex-wrap').forEach(row => {
        if (w > currentWeek || (w === currentWeek && row === excludeRow)) return;
        const [date, awaySel, homeSel] = row.querySelectorAll('input, select');
        if (awaySel.value && homeSel.value) {
          used.add(pairKey(awaySel.value, homeSel.value));
        }
      });
    });
    return used;
  }

  function updatePairingGuards(row, week) {
    const [date, awaySel, homeSel] = row.querySelectorAll('input, select');
    const used = getUsedPairs(week, row);
    const awayVal = awaySel.value;
    const homeVal = homeSel.value;
    Array.from(awaySel.options).forEach(opt => {
      const val = opt.value;
      opt.disabled = (val === homeVal) || (homeVal && used.has(pairKey(val, homeVal)));
    });
    Array.from(homeSel.options).forEach(opt => {
      const val = opt.value;
      opt.disabled = (val === awayVal) || (awayVal && used.has(pairKey(awayVal, val)));
    });
  }

  function updateAllPairingGuards() {
    document.querySelectorAll('#weeksContainer > div').forEach(div => {
      const week = Number(div.dataset.week);
      div.querySelectorAll('.flex.flex-wrap').forEach(row => updatePairingGuards(row, week));
    });
  }

  function createMatchRow(m = {}, week) {
    const row = document.createElement('div');
    row.className = 'flex flex-wrap items-center gap-2';
    const date = document.createElement('input');
    date.type = 'date';
    date.value = m.date || '';
    date.className = 'px-2 py-1 rounded bg-gray-800 border border-gray-700';
    const away = createTeamSelect(m.away);
    const at = document.createTextNode('@');
    const home = createTeamSelect(m.home);
    const awayScore = document.createElement('input');
    awayScore.type = 'number';
    awayScore.value = m.awayScore ?? '';
    awayScore.className = 'w-16 px-2 py-1 rounded bg-gray-800 border border-gray-700';
    const dash = document.createTextNode('-');
    const homeScore = document.createElement('input');
    homeScore.type = 'number';
    homeScore.value = m.homeScore ?? '';
    homeScore.className = 'w-16 px-2 py-1 rounded bg-gray-800 border border-gray-700';
    const remove = document.createElement('button');
    remove.textContent = 'X';
    remove.className = 'px-2 py-1 bg-red-600 rounded';
    remove.addEventListener('click', () => {
      row.remove();
      updateAllPairingGuards();
    });
    away.addEventListener('change', updateAllPairingGuards);
    home.addEventListener('change', updateAllPairingGuards);
    row.append(date, away, at, home, awayScore, dash, homeScore, remove);
    updatePairingGuards(row, week);
    return row;
  }

  function renderWeeks(weeks = []) {
    const container = document.getElementById('weeksContainer');
    container.innerHTML = '';
    weeks.forEach(w => {
      const div = document.createElement('div');
      div.className = 'border border-gray-700 p-3 rounded-md';
      div.dataset.week = w.week;
      const phase = w.phase || 'regular';
      div.dataset.phase = phase;

      const header = document.createElement('div');
      header.className = 'flex justify-between items-center mb-2';

      const left = document.createElement('div');
      left.className = 'flex items-center gap-2';

      const title = document.createElement('h3');
      title.className = 'font-semibold';
      title.textContent = `Week ${w.week}`;

      const phaseSelect = document.createElement('select');
      phaseSelect.className = 'px-2 py-1 rounded bg-gray-800 border border-gray-700';
      ['regular', 'playoffs', 'championship'].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p.charAt(0).toUpperCase() + p.slice(1);
        if (p === phase) opt.selected = true;
        phaseSelect.appendChild(opt);
      });
      phaseSelect.addEventListener('change', () => {
        div.dataset.phase = phaseSelect.value;
      });

      left.append(title, phaseSelect);

      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Match';
      addBtn.className = 'addMatch px-2 py-1 bg-gray-700 rounded';

      header.append(left, addBtn);
      div.appendChild(header);

      const matchesContainer = document.createElement('div');
      matchesContainer.className = 'space-y-2';
      (w.matches || []).forEach(m => matchesContainer.appendChild(createMatchRow(m, w.week)));
      div.appendChild(matchesContainer);
      container.appendChild(div);
    });
    updateAllPairingGuards();
  }

  function gatherSchedule() {
    return Array.from(document.querySelectorAll('#weeksContainer > div')).map(div => ({
      week: Number(div.dataset.week),
      phase: div.dataset.phase || 'regular',
      matches: Array.from(div.querySelectorAll('.flex.flex-wrap')).map(row => {
        const [date, awaySel, homeSel, awayScore, homeScore] = row.querySelectorAll('input, select');
        if (!awaySel.value || !homeSel.value || awaySel.value === homeSel.value) return null;
        return {
          date: date.value,
          away: awaySel.value,
          home: homeSel.value,
          awayScore: awayScore.value ? Number(awayScore.value) : null,
          homeScore: homeScore.value ? Number(homeScore.value) : null
        };
      }).filter(Boolean)
    }));
  }

  function addWeek(num) {
    const existing = gatherSchedule();
    const start = existing.length + 1;
    for (let i = 0; i < num; i++) {
      existing.push({ week: start + i, phase: 'regular', matches: [] });
    }
    renderWeeks(existing);
    renderStandings(computeStandings(existing));
  }

  function computeStandings(schedule) {
    const table = {};
    teams.forEach(t => (table[t] = { team: t, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0 }));
    schedule.forEach(w => {
      if (w.phase && w.phase !== 'regular') return;
      w.matches.forEach(m => {
        if (m.homeScore != null && m.awayScore != null) {
          table[m.home].pointsFor += m.homeScore;
          table[m.home].pointsAgainst += m.awayScore;
          table[m.away].pointsFor += m.awayScore;
          table[m.away].pointsAgainst += m.homeScore;
          if (m.homeScore > m.awayScore) {
            table[m.home].wins++;
            table[m.away].losses++;
          } else if (m.awayScore > m.homeScore) {
            table[m.away].wins++;
            table[m.home].losses++;
          }
        }
      });
    });
    return Object.values(table).map(r => {
      const games = r.wins + r.losses;
      const winPct = games ? r.wins / games : 0;
      const pointDiff = r.pointsFor - r.pointsAgainst;
      return { ...r, winPct, pointDiff };
    }).sort((a, b) => {
      if (b.winPct !== a.winPct) return b.winPct - a.winPct;
      if (b.pointDiff !== a.pointDiff) return b.pointDiff - a.pointDiff;
      return a.team.localeCompare(b.team);
    });
  }

  function renderStandings(rows) {
    const tableEl = document.getElementById('standingsTable');
    tableEl.innerHTML = '';
    const header = document.createElement('tr');
    header.innerHTML = '<th class="px-2">Team</th><th class="px-2">W</th><th class="px-2">L</th><th class="px-2">Win%</th><th class="px-2">+/-</th>';
    tableEl.appendChild(header);
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2">${r.team}</td><td class="px-2">${r.wins}</td><td class="px-2">${r.losses}</td><td class="px-2">${r.winPct.toFixed(3)}</td><td class="px-2">${r.pointDiff}</td>`;
      tableEl.appendChild(tr);
    });
  }

  async function loadSchedule() {
    const season = currentSeasonData.season;
    const division = document.getElementById('lmDivision').value;
    const docRef = doc(db, 'leagueSchedules', `${season}-${division}`);
    const snap = await getDoc(docRef);
    let weeks = [];
    if (snap.exists()) {
      weeks = snap.data().weeks || [];
    }
    renderWeeks(weeks);
    renderStandings(computeStandings(weeks));
  }

  document.getElementById('generateWeeks').addEventListener('click', () => {
    const num = parseInt(document.getElementById('weekCount').value);
    if (num > 0) addWeek(num);
  });

  document.getElementById('weeksContainer').addEventListener('click', e => {
    if (e.target.classList.contains('addMatch')) {
      const week = Number(e.target.closest('div[data-week]').dataset.week);
      const container = e.target.closest('div[data-week]').querySelector('.space-y-2');
      container.appendChild(createMatchRow({}, week));
      updateAllPairingGuards();
    }
  });

  document.getElementById('weeksContainer').addEventListener('change', e => {
    if (e.target.tagName === 'SELECT') {
      updateAllPairingGuards();
    }
    if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') {
      renderStandings(computeStandings(gatherSchedule()));
    }
  });

  document.getElementById('lmSeason').addEventListener('change', e => loadSeasonData(e.target.value));

  document.getElementById('lmDivision').addEventListener('change', async () => {
    await loadApprovedTeams();
    await loadSchedule();
  });

  document.getElementById('saveSchedule').addEventListener('click', async () => {
    const schedule = gatherSchedule();
    const season = currentSeasonData.season;
    const division = document.getElementById('lmDivision').value;
    const docRef = doc(db, 'leagueSchedules', `${season}-${division}`);
    await setDoc(docRef, { season, division, weeks: schedule });
    renderStandings(computeStandings(schedule));
  });

  document.getElementById('addSeason').addEventListener('click', async () => {
    const newId = seasonsIndex.length ? Math.max(...seasonsIndex.map(s => parseInt(s.id))) + 1 : 1;
    await setDoc(doc(db, 'leagueSeasons', String(newId)), {
      season: newId,
      divisions: { 'TPL-O': {}, 'TPL-IM': {}, 'TPL-I': {} },
      active: false
    });
    await loadSeasons();
    document.getElementById('lmSeason').value = String(newId);
    await loadSeasonData(newId);
  });

  document.getElementById('deleteSeason').addEventListener('click', async () => {
    const id = document.getElementById('lmSeason').value;
    if (!id || !confirm(`Delete Season ${id}?`)) return;
    if (currentSeasonData && currentSeasonData.divisions) {
      for (const div of Object.keys(currentSeasonData.divisions)) {
        await deleteDoc(doc(db, 'leagueSchedules', `${id}-${div}`));
      }
    }
    await deleteDoc(doc(db, 'leagueSeasons', id));
    await loadSeasons();
  });
</script>
  <script>
    async function loadNav() {
      const placeholder = document.getElementById('nav-placeholder');
      try {
        const res = await fetch('./nav.html');
        if (!res.ok) throw new Error(`Nav fetch failed: ${res.status}`);
        const html = await res.text();
        placeholder.innerHTML = html;
        placeholder.querySelectorAll('script').forEach(oldScript => {
          const newScript = document.createElement('script');
          [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
          newScript.textContent = oldScript.textContent;
          oldScript.replaceWith(newScript);
        });
        if (window.twitchOAuth) {
          window.twitchOAuth.updateNav();
          window.twitchOAuth.initLiveTeamsMenu();
        }
      } catch (err) {
        console.error('Failed to load navigation', err);
      }
    }
    loadNav();
  </script>
</body>
</html>
