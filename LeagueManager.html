<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPL Standings and Matches</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">
  <div id="nav-placeholder"></div>
  <script>
    fetch('nav.html').then(r => r.text()).then(html => {
      document.getElementById('nav-placeholder').innerHTML = html;
      if (window.twitchOAuth) {
        twitchOAuth.updateNav();
        twitchOAuth.initLiveTeamsMenu();
      }
    });
  </script>

  <div class="w-full max-w-4xl p-4">
    <h1 class="text-2xl font-bold text-center mb-4">TPL Standings and Matches</h1>
    <div class="flex flex-col md:flex-row gap-4 justify-center mb-6">
      <div>
        <label class="block text-sm mb-1">Season</label>
        <select id="lmSeason" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Division</label>
        <select id="lmDivision" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
    </div>

    <div>
      <h2 class="text-xl font-semibold mb-2">Standings</h2>
      <table id="standingsTable" class="min-w-full text-left"></table>
    </div>

    <div class="mt-6">
      <h2 class="text-xl font-semibold mb-2">Schedule</h2>
      <div id="scheduleContainer"></div>
    </div>
  </div>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);


    let seasonsIndex = [];
    let currentSeasonData = null;

    async function loadSeasons() {
      const res = await fetch('seasons/index.json');
      seasonsIndex = await res.json();
      const seasonSelect = document.getElementById('lmSeason');
      seasonsIndex.forEach(season => {
        const opt = document.createElement('option');
        opt.value = season.id;
        opt.textContent = `Season ${season.id}`;
        seasonSelect.appendChild(opt);
      });
      const active = seasonsIndex.filter(s => s.active).pop() || seasonsIndex[seasonsIndex.length - 1];
      seasonSelect.value = active.id;
      await loadSeasonData(active.id);
    }

    async function loadSeasonData(id) {
      const seasonInfo = seasonsIndex.find(s => s.id == id);
      if (!seasonInfo) return;
      const res = await fetch(`seasons/${seasonInfo.file}`);
      currentSeasonData = await res.json();
      const divisionSelect = document.getElementById('lmDivision');
      divisionSelect.innerHTML = '';
      Object.keys(currentSeasonData.divisions).forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        divisionSelect.appendChild(opt);
      });
      divisionSelect.value = Object.keys(currentSeasonData.divisions)[0];

      await renderDivision();
    }

    async function fetchTeams(season, division) {
      const q = query(
        collection(db, 'teams'),
        where('season', '==', season),
        where('division', '==', division),
        where('approved', '==', true)
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data());
    }

    async function renderDivision() {
      const divKey = document.getElementById('lmDivision').value;
      const divData = currentSeasonData.divisions[divKey];
      const teams = await fetchTeams(currentSeasonData.season, divKey);
      if (teams.length) {
        const standings = teams.map(t => ({ team: t.teamName, wins: 0, losses: 0 }));
        renderStandings(standings);
      } else {
        renderStandings(divData.standings);
      }
      renderSchedule(divData.schedule);
    }

    function renderStandings(rows) {
      const table = document.getElementById('standingsTable');
      table.innerHTML = '';
      const header = document.createElement('tr');
      header.innerHTML = '<th class="px-2">Team</th><th class="px-2">W</th><th class="px-2">L</th>';
      table.appendChild(header);
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-2">${r.team}</td><td class="px-2">${r.wins}</td><td class="px-2">${r.losses}</td>`;
        table.appendChild(tr);
      });
    }

    function renderSchedule(weeks) {
      const container = document.getElementById('scheduleContainer');
      container.innerHTML = '';
      weeks.forEach(w => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        const title = document.createElement('h3');
        title.className = 'font-semibold mb-1';
        title.textContent = `Week ${w.week}`;
        div.appendChild(title);
        const ul = document.createElement('ul');
        w.matches.forEach(m => {
          const li = document.createElement('li');
          li.textContent = `${m.date}: ${m.away} @ ${m.home}`;
          ul.appendChild(li);
        });
        div.appendChild(ul);
        container.appendChild(div);
      });
    }

    document.getElementById('lmSeason').addEventListener('change', e => loadSeasonData(e.target.value));
    document.getElementById('lmDivision').addEventListener('change', renderDivision);

    loadSeasons();
  </script>
</body>
</html>
