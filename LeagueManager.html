<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TPL League Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">
  <div id="nav-placeholder" data-include="/nav.html"></div>


  <div id="loginDiv" class="max-w-sm mx-auto mt-10 space-y-4">
    <h1 class="text-2xl font-bold text-center">Admin Login</h1>
    <input id="email" type="email" placeholder="Email" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <button id="loginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded">Login</button>
  </div>

  <div id="adminPanel" class="hidden w-full max-w-5xl p-4">
    <div class="flex justify-end mb-4">
      <button id="logoutBtn" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded">Logout</button>
    </div>
    <h1 class="text-2xl font-bold text-center mb-4">League Manager</h1>
    <div class="flex flex-col md:flex-row gap-4 mb-6">
      <div>
        <label class="block text-sm mb-1">Season</label>
        <div class="flex gap-2">
          <select id="lmSeason" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
          <button id="addSeason" class="px-2 py-1 bg-blue-600 rounded">+</button>
          <button id="deleteSeason" class="px-2 py-1 bg-red-600 rounded">&#x2212;</button>
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">Division</label>
        <select id="lmDivision" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Weeks</label>
        <div class="flex gap-2">
          <input id="weekCount" type="number" min="1" class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600 w-20">
          <button id="generateWeeks" class="px-3 py-2 bg-indigo-600 rounded-md text-white">Generate</button>
        </div>
      </div>
    </div>

    <div id="weeksContainer" class="space-y-6"></div>

    <button id="saveSchedule" class="mt-6 px-4 py-2 bg-green-600 rounded-md">Save Schedule</button>

    <div id="standingsSection" class="mt-10">
      <h2 class="text-xl font-semibold mb-2">Standings</h2>
      <table id="standingsTable" class="min-w-full text-left"></table>
    </div>
    <h1 class="text-3xl font-bold mt-12">Manage Teams</h1>
    <ul id="teamList" class="space-y-2 mt-4"></ul>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
    authDomain: "team-sign-up-b5646.firebaseapp.com",
    projectId: "team-sign-up-b5646",
    storageBucket: "team-sign-up-b5646.firebasestorage.app",
    messagingSenderId: "951471144681",
    appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth();

  let seasonsIndex = [];
  let currentSeasonData = null;
  let teams = [];

  const loginDiv = document.getElementById('loginDiv');
  const adminPanel = document.getElementById('adminPanel');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  loginBtn.addEventListener('click', () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
  });

  logoutBtn.addEventListener('click', () => signOut(auth));

  onAuthStateChanged(auth, user => {
    if (user) {
      loginDiv.classList.add('hidden');
      adminPanel.classList.remove('hidden');
      loadSeasons();
      loadTeams();
    } else {
      adminPanel.classList.add('hidden');
      loginDiv.classList.remove('hidden');
    }
  });

  async function loadSeasons() {
    const seasonSelect = document.getElementById('lmSeason');
    seasonSelect.innerHTML = '';
    const snap = await getDocs(collection(db, 'leagueSeasons'));
    seasonsIndex = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .sort((a, b) => parseInt(a.id) - parseInt(b.id));
    seasonsIndex.forEach(season => {
      const opt = document.createElement('option');
      opt.value = season.id;
      opt.textContent = `Season ${season.id}`;
      seasonSelect.appendChild(opt);
    });
    const active = seasonsIndex.find(s => s.active) || seasonsIndex[seasonsIndex.length - 1];
    if (active) {
      seasonSelect.value = active.id;
      await loadSeasonData(active.id);
    }
  }

  async function loadSeasonData(id) {
    const snap = await getDoc(doc(db, 'leagueSeasons', String(id)));
    if (!snap.exists()) return;
    currentSeasonData = snap.data();
    currentSeasonData.season = parseInt(id);
    const divisionSelect = document.getElementById('lmDivision');
    divisionSelect.innerHTML = '';
    Object.keys(currentSeasonData.divisions || {}).forEach(div => {
      const opt = document.createElement('option');
      opt.value = div;
      opt.textContent = div;
      divisionSelect.appendChild(opt);
    });
    if (divisionSelect.options.length > 0) {
      divisionSelect.value = divisionSelect.options[0].value;
    }
    await loadApprovedTeams();
    await loadSchedule();
  }

  async function loadApprovedTeams() {
    const season = currentSeasonData.season;
    const division = document.getElementById('lmDivision').value;
    const q = query(
      collection(db, 'teams'),
      where('season', '==', season),
      where('division', '==', division),
      where('approved', '==', true)
    );
    const snap = await getDocs(q);
    teams = snap.docs.map(d => d.data().teamName).sort();
  }

  async function loadTeams() {
    const list = document.getElementById('teamList');
    list.innerHTML = '';
    const snap = await getDocs(collection(db, 'teams'));
    snap.forEach(docSnap => {
      const data = docSnap.data();
      const li = document.createElement('li');
      li.className = 'bg-gray-800 p-3 rounded flex justify-between items-center';
      const players = (data.players || []).map(p => p.name).join(', ');
      const bench = (data.benchPlayers || []).join(', ');
      li.innerHTML = `
        <div>
          <strong>${data.teamName} [${data.teamTag}]</strong> - Season ${data.season} ${data.division}<br>
          Players: ${players}${bench ? `<br>Bench: ${bench}` : ''}
        </div>
        <span>
          <button data-id="${docSnap.id}" data-approved="${data.approved}" class="team-approve bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded mr-2">${data.approved ? 'Unapprove' : 'Approve'}</button>
          <button data-id="${docSnap.id}" class="team-edit bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded mr-2">Edit</button>
          <button data-id="${docSnap.id}" class="team-delete bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Delete</button>
        </span>`;
      list.appendChild(li);
    });

    list.querySelectorAll('.team-delete').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      await deleteDoc(doc(db, 'teams', id));
      loadTeams();
    }));

    list.querySelectorAll('.team-approve').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      const approved = e.target.dataset.approved === 'true';
      await updateDoc(doc(db, 'teams', id), { approved: !approved });
      loadTeams();
    }));

    list.querySelectorAll('.team-edit').forEach(btn => btn.addEventListener('click', async e => {
      const id = e.target.dataset.id;
      const docRef = doc(db, 'teams', id);
      const snap = await getDoc(docRef);
      if (!snap.exists()) return;
      const data = snap.data();
      const teamName = prompt('Team Name', data.teamName) || data.teamName;
      const teamTag = prompt('Team Tag', data.teamTag) || data.teamTag;
      const season = parseInt(prompt('Season', data.season), 10) || data.season;
      const division = prompt('Division', data.division) || data.division;
      const playersText = prompt('Players (Name|Twitch per line)', (data.players || []).map(p => `${p.name}|${p.twitch}`).join('\n')) || '';
      const players = playersText.split('\n').map(l => {
        const [name, twitch = ''] = l.split('|').map(s => s.trim());
        return name ? { name, twitch } : null;
      }).filter(Boolean);
      const benchText = prompt('Bench Players (comma separated)', (data.benchPlayers || []).join(', ')) || '';
      const benchPlayers = benchText.split(',').map(p => p.trim()).filter(Boolean);
      await updateDoc(docRef, { teamName, teamTag, season, division, players, benchPlayers });
      loadTeams();
    }));
  }

  function createTeamSelect(selected) {
    const sel = document.createElement('select');
    sel.className = 'px-2 py-1 rounded bg-gray-800 border border-gray-700';
    teams.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      if (t === selected) opt.selected = true;
      sel.appendChild(opt);
    });
    return sel;
  }

  function createMatchRow(m = {}) {
    const row = document.createElement('div');
    row.className = 'flex flex-wrap items-center gap-2';
    const date = document.createElement('input');
    date.type = 'date';
    date.value = m.date || '';
    date.className = 'px-2 py-1 rounded bg-gray-800 border border-gray-700';
    const away = createTeamSelect(m.away);
    const at = document.createTextNode('@');
    const home = createTeamSelect(m.home);
    const awayScore = document.createElement('input');
    awayScore.type = 'number';
    awayScore.value = m.awayScore ?? '';
    awayScore.className = 'w-16 px-2 py-1 rounded bg-gray-800 border border-gray-700';
    const dash = document.createTextNode('-');
    const homeScore = document.createElement('input');
    homeScore.type = 'number';
    homeScore.value = m.homeScore ?? '';
    homeScore.className = 'w-16 px-2 py-1 rounded bg-gray-800 border border-gray-700';
    const remove = document.createElement('button');
    remove.textContent = 'X';
    remove.className = 'px-2 py-1 bg-red-600 rounded';
    remove.addEventListener('click', () => row.remove());
    row.append(date, away, at, home, awayScore, dash, homeScore, remove);
    return row;
  }

  function renderWeeks(weeks = []) {
    const container = document.getElementById('weeksContainer');
    container.innerHTML = '';
    weeks.forEach(w => {
      const div = document.createElement('div');
      div.className = 'border border-gray-700 p-3 rounded-md';
      div.dataset.week = w.week;
      const phase = w.phase || 'regular';
      div.dataset.phase = phase;

      const header = document.createElement('div');
      header.className = 'flex justify-between items-center mb-2';

      const left = document.createElement('div');
      left.className = 'flex items-center gap-2';

      const title = document.createElement('h3');
      title.className = 'font-semibold';
      title.textContent = `Week ${w.week}`;

      const phaseSelect = document.createElement('select');
      phaseSelect.className = 'px-2 py-1 rounded bg-gray-800 border border-gray-700';
      ['regular', 'playoffs', 'championship'].forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p.charAt(0).toUpperCase() + p.slice(1);
        if (p === phase) opt.selected = true;
        phaseSelect.appendChild(opt);
      });
      phaseSelect.addEventListener('change', () => {
        div.dataset.phase = phaseSelect.value;
      });

      left.append(title, phaseSelect);

      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Match';
      addBtn.className = 'addMatch px-2 py-1 bg-gray-700 rounded';

      header.append(left, addBtn);
      div.appendChild(header);

      const matchesContainer = document.createElement('div');
      matchesContainer.className = 'space-y-2';
      (w.matches || []).forEach(m => matchesContainer.appendChild(createMatchRow(m)));
      div.appendChild(matchesContainer);
      container.appendChild(div);
    });
  }

  function gatherSchedule() {
    return Array.from(document.querySelectorAll('#weeksContainer > div')).map(div => ({
      week: Number(div.dataset.week),
      phase: div.dataset.phase || 'regular',
      matches: Array.from(div.querySelectorAll('.flex.flex-wrap')).map(row => {
        const [date, awaySel, homeSel, awayScore, homeScore] = row.querySelectorAll('input, select');
        return {
          date: date.value,
          away: awaySel.value,
          home: homeSel.value,
          awayScore: awayScore.value ? Number(awayScore.value) : null,
          homeScore: homeScore.value ? Number(homeScore.value) : null
        };
      })
    }));
  }

  function addWeek(num) {
    const existing = gatherSchedule();
    const start = existing.length + 1;
    for (let i = 0; i < num; i++) {
      existing.push({ week: start + i, phase: 'regular', matches: [] });
    }
    renderWeeks(existing);
  }

  function computeStandings(schedule) {
    const table = {};
    teams.forEach(t => (table[t] = { team: t, wins: 0, losses: 0 }));
    schedule.forEach(w => {
      if (w.phase && w.phase !== 'regular') return;
      w.matches.forEach(m => {
        if (m.homeScore != null && m.awayScore != null) {
          if (m.homeScore > m.awayScore) {
            table[m.home].wins++;
            table[m.away].losses++;
          } else if (m.awayScore > m.homeScore) {
            table[m.away].wins++;
            table[m.home].losses++;
          }
        }
      });
    });
    return Object.values(table);
  }

  function renderStandings(rows) {
    const tableEl = document.getElementById('standingsTable');
    tableEl.innerHTML = '';
    const header = document.createElement('tr');
    header.innerHTML = '<th class="px-2">Team</th><th class="px-2">W</th><th class="px-2">L</th>';
    tableEl.appendChild(header);
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="px-2">${r.team}</td><td class="px-2">${r.wins}</td><td class="px-2">${r.losses}</td>`;
      tableEl.appendChild(tr);
    });
  }

  async function loadSchedule() {
    const season = currentSeasonData.season;
    const division = document.getElementById('lmDivision').value;
    const docRef = doc(db, 'leagueSchedules', `${season}-${division}`);
    const snap = await getDoc(docRef);
    let weeks = [];
    if (snap.exists()) {
      weeks = snap.data().weeks || [];
    }
    renderWeeks(weeks);
    renderStandings(computeStandings(weeks));
  }

  document.getElementById('generateWeeks').addEventListener('click', () => {
    const num = parseInt(document.getElementById('weekCount').value);
    if (num > 0) addWeek(num);
  });

  document.getElementById('weeksContainer').addEventListener('click', e => {
    if (e.target.classList.contains('addMatch')) {
      const container = e.target.closest('div[data-week]').querySelector('.space-y-2');
      container.appendChild(createMatchRow());
    }
  });

  document.getElementById('lmSeason').addEventListener('change', e => loadSeasonData(e.target.value));

  document.getElementById('lmDivision').addEventListener('change', async () => {
    await loadApprovedTeams();
    await loadSchedule();
  });

  document.getElementById('saveSchedule').addEventListener('click', async () => {
    const schedule = gatherSchedule();
    const season = currentSeasonData.season;
    const division = document.getElementById('lmDivision').value;
    const docRef = doc(db, 'leagueSchedules', `${season}-${division}`);
    await setDoc(docRef, { season, division, weeks: schedule });
    renderStandings(computeStandings(schedule));
  });

  document.getElementById('addSeason').addEventListener('click', async () => {
    const newId = seasonsIndex.length ? Math.max(...seasonsIndex.map(s => parseInt(s.id))) + 1 : 1;
    await setDoc(doc(db, 'leagueSeasons', String(newId)), {
      season: newId,
      divisions: { 'TPL-O': {}, 'TPL-IM': {}, 'TPL-I': {} },
      active: false
    });
    await loadSeasons();
    document.getElementById('lmSeason').value = String(newId);
    await loadSeasonData(newId);
  });

  document.getElementById('deleteSeason').addEventListener('click', async () => {
    const id = document.getElementById('lmSeason').value;
    if (!id || !confirm(`Delete Season ${id}?`)) return;
    if (currentSeasonData && currentSeasonData.divisions) {
      for (const div of Object.keys(currentSeasonData.divisions)) {
        await deleteDoc(doc(db, 'leagueSchedules', `${id}-${div}`));
      }
    }
    await deleteDoc(doc(db, 'leagueSeasons', id));
    await loadSeasons();
  });
</script>
  <script>
    async function loadNav() {
      const placeholder = document.getElementById('nav-placeholder');
      try {
        const res = await fetch('./nav.html');
        if (!res.ok) throw new Error(`Nav fetch failed: ${res.status}`);
        const html = await res.text();
        placeholder.innerHTML = html;
        placeholder.querySelectorAll('script').forEach(oldScript => {
          const newScript = document.createElement('script');
          [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
          newScript.textContent = oldScript.textContent;
          oldScript.replaceWith(newScript);
        });
        if (window.twitchOAuth) {
          window.twitchOAuth.updateNav();
          window.twitchOAuth.initLiveTeamsMenu();
        }
      } catch (err) {
        console.error('Failed to load navigation', err);
      }
    }
    loadNav();
  </script>
</body>
</html>
