<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>League Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div id="nav-placeholder"></div>
  <script>
    fetch('nav.html').then(r => r.text()).then(html => {
      document.getElementById('nav-placeholder').innerHTML = html;
      if (window.twitchOAuth) {
        twitchOAuth.updateNav();
        twitchOAuth.initLiveTeamsMenu();
        const panel = document.getElementById('live-teams-panel');
        if (panel) panel.style.top = '9rem';
      }
    });
  </script>

  <div id="loginDiv" class="max-w-sm mx-auto mt-10 space-y-4">
    <h1 class="text-2xl font-bold text-center">Admin Login</h1>
    <input id="email" type="email" placeholder="Email" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <button id="loginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded">Login</button>
  </div>

  <div id="adminPanel" class="hidden container mx-auto px-4 mt-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">League Admin</h1>
      <button id="logoutBtn" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded">Logout</button>
    </div>

    <h2 class="text-2xl font-bold mb-4">Manage Streamers</h2>
    <form id="addStreamerForm" class="space-y-4 mb-8">
      <div>
        <label class="block text-sm mb-1">Display Name</label>
        <input id="displayName" type="text" required class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
      </div>
      <div>
        <label class="block text-sm mb-1">Twitch Handle</label>
        <input id="twitchHandle" type="text" required class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
      </div>
      <div>
        <label class="block text-sm mb-1">Team (optional)</label>
        <input id="team" type="text" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
      </div>
      <div>
        <label class="block text-sm mb-1">Bio (optional)</label>
        <textarea id="bio" rows="3" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700"></textarea>
      </div>
      <button type="submit" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded">Add Streamer</button>
    </form>

    <ul id="streamerList" class="space-y-2"></ul>

    <h2 class="text-2xl font-bold mt-12">Manage Teams</h2>
    <ul id="teamList" class="space-y-2 mt-4"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const loginDiv = document.getElementById('loginDiv');
    const adminPanel = document.getElementById('adminPanel');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    loginBtn.addEventListener('click', () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, user => {
      if (user) {
        loginDiv.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        loadStreamers();
        loadTeams();
      } else {
        loginDiv.classList.remove('hidden');
        adminPanel.classList.add('hidden');
      }
    });

    document.getElementById('addStreamerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const displayName = document.getElementById('displayName').value.trim();
      const handle = document.getElementById('twitchHandle').value.trim();
      const team = document.getElementById('team').value.trim();
      const bio = document.getElementById('bio').value.trim();
      if (!displayName || !handle) return;
      const avatarUrl = `https://decapi.me/twitch/avatar/${encodeURIComponent(handle)}`;
      await addDoc(collection(db, 'streamers'), { displayName, twitchHandle: handle, team, bio, avatarUrl, approved: true });
      e.target.reset();
      loadStreamers();
    });

    async function loadStreamers() {
      const list = document.getElementById('streamerList');
      list.innerHTML = '';
      const snap = await getDocs(collection(db, 'streamers'));
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const li = document.createElement('li');
        li.className = 'bg-gray-800 p-3 rounded flex justify-between items-center';
        li.innerHTML = `
          <span><strong>${data.displayName}</strong> - ${data.twitchHandle} ${data.team ? `(${data.team})` : ''}</span>
          <span>
            <button data-id="${docSnap.id}" data-approved="${data.approved}" class="approve bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded mr-2">${data.approved ? 'Unapprove' : 'Approve'}</button>
            <button data-id="${docSnap.id}" class="delete bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Delete</button>
          </span>
        `;
        list.appendChild(li);
      });

      list.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        await deleteDoc(doc(db, 'streamers', id));
        loadStreamers();
      }));

      list.querySelectorAll('.approve').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        const approved = e.target.dataset.approved === 'true';
        await updateDoc(doc(db, 'streamers', id), { approved: !approved });
        loadStreamers();
      }));
    }

    async function loadTeams() {
      const list = document.getElementById('teamList');
      list.innerHTML = '';
      const snap = await getDocs(collection(db, 'teams'));
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const li = document.createElement('li');
        li.className = 'bg-gray-800 p-3 rounded flex justify-between items-center';
        const players = (data.players || []).map(p => p.name).join(', ');
        const bench = (data.benchPlayers || []).join(', ');
        li.innerHTML = `
          <div>
            <strong>${data.teamName} [${data.teamTag}]</strong> - Season ${data.season} ${data.division}<br>
            Players: ${players}${bench ? `<br>Bench: ${bench}` : ''}
          </div>
          <span>
            <button data-id="${docSnap.id}" data-approved="${data.approved}" class="team-approve bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded mr-2">${data.approved ? 'Unapprove' : 'Approve'}</button>
            <button data-id="${docSnap.id}" class="team-edit bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded mr-2">Edit</button>
            <button data-id="${docSnap.id}" class="team-delete bg-red-600 hover:bg-red-700 px-2 py-1 rounded">Delete</button>
          </span>`;
        list.appendChild(li);
      });

      list.querySelectorAll('.team-delete').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        await deleteDoc(doc(db, 'teams', id));
        loadTeams();
      }));

      list.querySelectorAll('.team-approve').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        const approved = e.target.dataset.approved === 'true';
        await updateDoc(doc(db, 'teams', id), { approved: !approved });
        loadTeams();
      }));

      list.querySelectorAll('.team-edit').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        const docRef = doc(db, 'teams', id);
        const snap = await getDoc(docRef);
        if (!snap.exists()) return;
        const data = snap.data();
        const teamName = prompt('Team Name', data.teamName) || data.teamName;
        const teamTag = prompt('Team Tag', data.teamTag) || data.teamTag;
        const season = parseInt(prompt('Season', data.season), 10) || data.season;
        const division = prompt('Division', data.division) || data.division;
        const playersText = prompt('Players (Name|Twitch per line)', (data.players || []).map(p => `${p.name}|${p.twitch}`).join('\n')) || '';
        const players = playersText.split('\n').map(l => {
          const [name, twitch = ''] = l.split('|').map(s => s.trim());
          return name ? { name, twitch } : null;
        }).filter(Boolean);
        const benchText = prompt('Bench Players (comma separated)', (data.benchPlayers || []).join(', ')) || '';
        const benchPlayers = benchText.split(',').map(p => p.trim()).filter(Boolean);
        await updateDoc(docRef, { teamName, teamTag, season, division, players, benchPlayers });
        loadTeams();
      }));
    }
  </script>
</body>
</html>
