<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team Sign-Up</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="oauth.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center">
    <div id="nav-placeholder" data-include="nav.html"></div>


  <div class="bg-gray-800 shadow-lg rounded-2xl p-8 w-full max-w-2xl mt-8">

    <h1 class="text-2xl font-bold text-center mb-6">Team Sign-Up</h1>

    <form id="teamForm" class="space-y-4">
      <div>
        <label class="block text-sm mb-1">Team Name</label>
        <input type="text" id="teamName" required
          class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-sm mb-1">Team Tag</label>
        <input type="text" id="teamTag" required
          class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div>
        <label class="block text-sm mb-1">Season</label>
        <select id="seasonSelect" required class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
      </div>

      <div>
        <label class="block text-sm mb-1">Division</label>
        <select id="divisionSelect" required class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
      </div>

      <div id="playersContainer" class="space-y-2"></div>
      <button type="button" id="addPlayerBtn"
        class="w-full py-1 rounded-md bg-gray-700 hover:bg-gray-600">Add Player</button>

      <div>
        <label class="block text-sm mb-1">Bench Players (comma separated)</label>
        <input type="text" id="benchPlayers"
          class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <button type="submit" id="submitTeamBtn"
        class="w-full py-2 rounded-md bg-blue-600 hover:bg-blue-700 font-semibold">Add Team</button>
      <p id="formStatus" class="text-center text-sm mt-2"></p>
    </form>

    <div class="mt-6">
      <h2 class="text-lg font-bold mb-2">Teams</h2>
      <div id="loadingIndicator" class="text-center text-gray-400 mb-4">Loading teams...</div>
      <ul id="teamOutput" class="space-y-2"></ul>
      <button id="exportExcel" class="w-full mt-4 py-2 rounded-md bg-green-600 hover:bg-green-700">Export to Excel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const form = document.getElementById("teamForm");
    const output = document.getElementById("teamOutput");
    const playersContainer = document.getElementById("playersContainer");
    const addPlayerBtn = document.getElementById("addPlayerBtn");
    const seasonSelect = document.getElementById('seasonSelect');
    const divisionSelect = document.getElementById('divisionSelect');
    const status = document.getElementById('formStatus');
    const submitTeamBtn = document.getElementById('submitTeamBtn');
    const loadingIndicator = document.getElementById('loadingIndicator');
    let playerCount = 0;
    let seasonsIndex = [];
    const divisionLabels = {
      'TPL-O': 'Open',
      'TPL-IM': 'Intermediate',
      'TPL-I': 'Invite'
    };
    const allowedDivisions = Object.keys(divisionLabels);
    let isAuthenticated = false;

    // Initialize Firebase Authentication
    async function initializeAuth() {
      try {
        await signInAnonymously(auth);
        console.log('Signed in anonymously');
      } catch (error) {
        console.error('Failed to sign in anonymously:', error);
        status.textContent = 'Failed to initialize authentication. Please refresh the page.';
      }
    }

    // Monitor authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        isAuthenticated = true;
        console.log('User authenticated:', user.uid);
        // Load data once authenticated
        loadSeasons();
        loadTeams();
      } else {
        isAuthenticated = false;
        console.log('User not authenticated');
      }
    });

    function addPlayerRow(name = "", twitch = "") {
      if (playerCount >= 7) return;
      playerCount++;
      const div = document.createElement("div");
      div.className = "grid grid-cols-1 md:grid-cols-2 gap-2 player-row";
      div.innerHTML = `
        <input type="text" placeholder="Player ${playerCount} Name" class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${name}">
        <input type="text" placeholder="Twitch URL" class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${twitch}">
      `;
      playersContainer.appendChild(div);
    }

    // Ensure at least one player row exists on initial load
    addPlayerBtn.addEventListener("click", () => addPlayerRow());
    addPlayerRow();

    async function loadSeasons() {
      seasonSelect.innerHTML = '';
      const snap = await getDocs(collection(db, 'leagueSeasons'));
      seasonsIndex = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => parseInt(a.id) - parseInt(b.id));
      seasonsIndex.forEach(season => {
        const opt = document.createElement('option');
        opt.value = season.id;
        opt.textContent = `Season ${season.id}`;
        seasonSelect.appendChild(opt);
      });
      const active = seasonsIndex.find(s => s.active) || seasonsIndex[seasonsIndex.length - 1];
      if (active) {
        seasonSelect.value = active.id;
        await loadDivisions(active.id);
      }
    }

    async function loadDivisions(id) {
      const snap = await getDoc(doc(db, 'leagueSeasons', String(id)));
      if (!snap.exists()) return;
      const data = snap.data();
      divisionSelect.innerHTML = '';
      Object.keys(data.divisions || {}).forEach(div => {
        if (!divisionLabels[div]) return;
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = divisionLabels[div];
        divisionSelect.appendChild(opt);
      });
    }

    seasonSelect.addEventListener('change', e => loadDivisions(e.target.value));

    async function loadTeams() {
      if (!isAuthenticated) {
        console.log('Not authenticated, skipping team load');
        return;
      }
      
      output.innerHTML = "";
      try {
        const snapshot = await getDocs(collection(db, "teams"));
        let hasApprovedTeams = false;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          // Only show approved teams to regular users
          if (data.approved) {
            hasApprovedTeams = true;
            const li = document.createElement("li");
            li.className = "bg-gray-700 p-2 rounded-md";
            const players = (data.players || []).map(p => p.name).join(', ');
            const bench = (data.benchPlayers || []).join(', ');
            li.innerHTML = `<strong>${data.teamName} [${data.teamTag}]</strong> - Season ${data.season} ${data.division}<br>Players: ${players}${bench ? `<br>Bench: ${bench}` : ''}`;
            output.appendChild(li);
          }
        });
        
        if (!hasApprovedTeams) {
          const li = document.createElement("li");
          li.className = "bg-gray-700 p-2 rounded-md text-center text-gray-400";
          li.textContent = "No approved teams yet. Submit your team below!";
          output.appendChild(li);
        }
        
        // Hide loading indicator
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      } catch (error) {
        console.error('Failed to load teams:', error);
        const li = document.createElement("li");
        li.className = "bg-red-700 p-2 rounded-md text-center";
        li.textContent = "Failed to load teams. Please refresh the page.";
        output.appendChild(li);
        
        // Hide loading indicator even on error
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      }
    }

    async function submitTeam(e) {
      e.preventDefault();
      status.textContent = '';
      
      if (!isAuthenticated) {
        status.textContent = 'Please wait for authentication to complete.';
        return;
      }
      
      const teamName = document.getElementById("teamName").value.trim();
      const teamTag = document.getElementById("teamTag").value.trim();
      const season = parseInt(seasonSelect.value, 10);
      const division = divisionSelect.value;
      const benchPlayers = document.getElementById("benchPlayers").value.trim().split(',').map(p => p.trim()).filter(Boolean);
      const players = Array.from(playersContainer.querySelectorAll('.player-row')).map(row => {
        const inputs = row.querySelectorAll('input');
        const name = inputs[0].value.trim();
        const twitch = inputs[1].value.trim();
        if (!name) return null;
        return { name, twitch };
      }).filter(Boolean);
      
      if (!teamName || !teamTag || players.length === 0 || !division || isNaN(season)) {
        status.textContent = 'Please fill out team info and at least one player.';
        return;
      }
      if (!allowedDivisions.includes(division)) {
        status.textContent = 'Invalid division selected.';
        return;
      }

      // Disable submit button to prevent double submission
      submitTeamBtn.disabled = true;
      submitTeamBtn.textContent = 'Submitting...';

      try {
        await addDoc(collection(db, "teams"), { 
          teamName, 
          teamTag, 
          season, 
          division, 
          players, 
          benchPlayers, 
          approved: false,
          submittedAt: new Date()
        });
        status.textContent = 'Team submitted for approval.';
        status.className = 'text-center text-sm mt-2 text-green-400';
        form.reset();
        playersContainer.innerHTML = '';
        playerCount = 0;
        addPlayerRow();
        loadDivisions(seasonSelect.value);
        loadTeams();
      } catch (err) {
        console.error('Failed to add team', err);
        status.textContent = `Failed to submit team: ${err.message}`;
        status.className = 'text-center text-sm mt-2 text-red-400';
      } finally {
        // Re-enable submit button
        submitTeamBtn.disabled = false;
        submitTeamBtn.textContent = 'Add Team';
      }
    }

    form.addEventListener("submit", submitTeam);

    // Initialize authentication when the page loads
    initializeAuth();

    document.getElementById('exportExcel').addEventListener('click', () => {
      const rows = [];
      output.querySelectorAll('li').forEach(li => {
        const text = li.innerHTML.replace(/<br>/g, '\n');
        const clean = text.replace(/<\/?.*?>/g, '').split('\n');
        const teamMatch = clean[0].match(/^(.*) \[(.*)\]$/) || [];
        const players = (clean[1] || '').replace(/^Players: /, '').split(',').map(p => p.trim()).filter(Boolean);
        const bench = (clean[2] || '').replace(/^Bench: /, '').split(',').map(p => p.trim()).filter(Boolean);
        rows.push({
          teamName: teamMatch[1] || '',
          teamTag: teamMatch[2] || '',
          players: players.join(', '),
          bench: bench.join(', ')
        });
      });
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Teams');
      XLSX.writeFile(wb, 'teams.xlsx');
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    async function loadNav() {
      const placeholder = document.getElementById('nav-placeholder');
      try {
        const res = await fetch('./nav.html');
        if (!res.ok) throw new Error(`Nav fetch failed: ${res.status}`);
        const html = await res.text();
        placeholder.innerHTML = html;
        placeholder.querySelectorAll('script').forEach(oldScript => {
          const newScript = document.createElement('script');
          [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
          newScript.textContent = oldScript.textContent;
          oldScript.replaceWith(newScript);
        });
        if (window.twitchOAuth) {
          window.twitchOAuth.updateNav();
          window.twitchOAuth.initLiveTeamsMenu();
        }
      } catch (err) {
        console.error('Failed to load navigation', err);
      }
    }
    loadNav();
  </script>
</body>
</html>
