<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Match Stats Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="oauth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div id="nav-placeholder" data-include="nav.html"></div>

  <div id="loginDiv" class="max-w-sm mx-auto mt-10 space-y-4">
    <h1 class="text-2xl font-bold text-center">Admin Login</h1>
    <input id="email" type="email" placeholder="Email" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <input id="password" type="password" placeholder="Password" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700" />
    <button id="loginBtn" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded">Login</button>
  </div>

  <div id="adminPanel" class="hidden container mx-auto px-4 mt-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Match Stats Admin</h1>
      <button id="logoutBtn" class="py-2 px-4 bg-red-600 hover:bg-red-700 rounded">Logout</button>
    </div>

    <form id="matchForm" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div>
        <label class="block text-sm mb-1">Team 1</label>
        <select id="team1" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Team 2</label>
        <select id="team2" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Map</label>
        <select id="map" class="w-full px-3 py-2 rounded bg-gray-800 border border-gray-700"></select>
      </div>
      <div class="flex items-end">
        <button type="button" id="createMatch" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded">Create Match</button>
      </div>
    </form>

    <div id="statsSection" class="hidden">
      <div id="team1Stats"></div>
      <div id="team2Stats" class="mt-8"></div>
      <div class="mt-6 flex gap-4">
        <button id="saveMatch" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">Save Match</button>
        <button id="exportBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded" disabled>Export to Excel</button>
      </div>
      <div id="output" class="mt-8"></div>
    </div>

    <div id="matchesList" class="mt-12"></div>

  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';

    import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB_ksHlcP2P9cT5jbo2IAGxbQ4zgEODkyM",
      authDomain: "team-sign-up-b5646.firebaseapp.com",
      projectId: "team-sign-up-b5646",
      storageBucket: "team-sign-up-b5646.firebasestorage.app",
      messagingSenderId: "951471144681",
      appId: "1:951471144681:web:a2458675ce73ce9ad9ba78"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const ADMIN_UIDS = [
      'DkBHsCzLK5a9KiX50g0pHJrEqGq2',
      'A2ZV8vziNsXqZkyqHzAB266B9pP2'
    ];

    const loginDiv = document.getElementById('loginDiv');
    const adminPanel = document.getElementById('adminPanel');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    let editingMatchId = null, currentMatchCreated = null;

    const toNumber = (value) => {
      const num = parseFloat(value);
      return Number.isFinite(num) ? num : 0;
    };


    loginBtn.addEventListener('click', () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, user => {
      if (user && ADMIN_UIDS.includes(user.uid)) {
        loginDiv.classList.add('hidden');
        adminPanel.classList.remove('hidden');

        loadTeams().then(loadMatches);

      } else {
        loginDiv.classList.remove('hidden');
        adminPanel.classList.add('hidden');
        if (user) {
          alert('Access denied.');
          signOut(auth);
        }
      }
    });

    const mapList = ['Dry Dock','Raindance','Hollow','Dangerous Crossing','Torment','Katabatic','Wave Mist','Moonrise'];
    const mapSelect = document.getElementById('map');
    mapList.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      mapSelect.appendChild(opt);
    });

    let teamsData = [];

    async function loadTeams() {
      const snap = await getDocs(collection(db, 'teams'));
      teamsData = snap.docs.map(d => ({ id: d.id, name: d.data().teamName, players: (d.data().players || []).map(p => p.name) }));
      const team1Sel = document.getElementById('team1');
      const team2Sel = document.getElementById('team2');
      team1Sel.innerHTML = '<option value="">Select Team</option>';
      team2Sel.innerHTML = '<option value="">Select Team</option>';
      teamsData.forEach(t => {
        const opt1 = document.createElement('option');
        opt1.value = t.id;
        opt1.textContent = t.name;
        team1Sel.appendChild(opt1);
        const opt2 = document.createElement('option');
        opt2.value = t.id;
        opt2.textContent = t.name;
        team2Sel.appendChild(opt2);
      });
    }

    async function loadMatches() {
      const snap = await getDocs(collection(db, 'matches'));
      const listDiv = document.getElementById('matchesList');
      listDiv.innerHTML = '<h2 class="text-2xl font-bold mb-4">Saved Matches</h2>';
      if (snap.empty) {
        listDiv.innerHTML += '<p>No matches saved.</p>';
        return;
      }
      const table = document.createElement('table');
      table.className = 'min-w-full text-left border border-gray-700';
      table.innerHTML = `
        <thead>
          <tr>
            <th class="px-2">Date</th>
            <th class="px-2">Map</th>
            <th class="px-2">Teams</th>
            <th class="px-2">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');
      snap.forEach(docSnap => {
        const data = docSnap.data();
        let dateStr = '';
        try { dateStr = data.created.toDate().toLocaleString(); } catch(e) { dateStr = ''; }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-2">${dateStr}</td>
          <td class="px-2">${data.map}</td>
          <td class="px-2">${data.team1} vs ${data.team2}</td>
          <td class="px-2 space-x-2">
            <button class="edit-btn bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded" data-id="${docSnap.id}">Edit</button>
            <button class="delete-btn bg-red-600 hover:bg-red-700 px-2 py-1 rounded" data-id="${docSnap.id}">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
        tr.querySelector('.edit-btn').addEventListener('click', () => loadMatchForEdit(docSnap.id, data));
        tr.querySelector('.delete-btn').addEventListener('click', () => deleteMatch(docSnap.id));
      });
      listDiv.appendChild(table);
    }

    async function deleteMatch(id) {
      if (!confirm('Delete this match?')) return;
      await deleteDoc(doc(db, 'matches', id));
      if (editingMatchId === id) {
        editingMatchId = null;
        currentMatchCreated = null;
        const statsSection = document.getElementById('statsSection');
        statsSection.classList.add('hidden');
        document.getElementById('saveMatch').textContent = 'Save Match';
        resetOutput();
      }
      loadMatches();
    }

    function loadMatchForEdit(id, data) {
      editingMatchId = id;
      currentMatchCreated = data.created;
      document.getElementById('saveMatch').textContent = 'Update Match';
      const team1 = teamsData.find(t => t.name === data.team1);
      const team2 = teamsData.find(t => t.name === data.team2);
      document.getElementById('team1').value = team1 ? team1.id : '';
      document.getElementById('team2').value = team2 ? team2.id : '';
      document.getElementById('map').value = data.map;
      const team1Stats = data.stats?.[data.team1] || null;
      const team2Stats = data.stats?.[data.team2] || null;
      const team1ForTable = team1 || { name: data.team1, players: Object.keys(team1Stats?.players || {}) };
      const team2ForTable = team2 || { name: data.team2, players: Object.keys(team2Stats?.players || {}) };
      createStatsTable('team1Stats', team1ForTable, team1Stats);
      createStatsTable('team2Stats', team2ForTable, team2Stats);
      document.getElementById('statsSection').classList.remove('hidden');
      const inputs = document.querySelectorAll('.stat-input');
      inputs.forEach(inp => {
        const player = inp.dataset.player;
        const team = inp.dataset.team;
        const stat = inp.dataset.stat;
        const teamData = data.stats?.[team];
        if (teamData && teamData.players[player]) {
          inp.value = teamData.players[player][stat] || 0;
        }
      });
      renderRunningTotals(data.stats || {});
    }

    document.getElementById('createMatch').addEventListener('click', () => {
      const t1 = teamsData.find(t => t.id === document.getElementById('team1').value);
      const t2 = teamsData.find(t => t.id === document.getElementById('team2').value);
      if (!t1 || !t2 || t1.id === t2.id) {
        alert('Please select two different teams.');
        return;
      }
      editingMatchId = null;
      currentMatchCreated = null;
      document.getElementById('saveMatch').textContent = 'Save Match';

      createStatsTable('team1Stats', t1);
      createStatsTable('team2Stats', t2);
      document.getElementById('statsSection').classList.remove('hidden');
      resetOutput();
    });

    function createStatsTable(containerId, team, existingStats = null) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      const wrapper = document.createElement('div');
      wrapper.className = 'space-y-2';

      const table = document.createElement('table');
      table.className = 'min-w-full text-left border border-gray-700';
      table.innerHTML = `
        <caption class="text-xl font-semibold mb-2">${team.name}</caption>
        <thead>
          <tr>
            <th class="px-2">Player</th>
            <th class="px-2">Kills</th>
            <th class="px-2">Assists</th>
            <th class="px-2">Score</th>
            <th class="px-2">Captures</th>
            <th class="px-2">Returns</th>
            <th class="px-2">Time (min)</th>
            <th class="px-2">Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');

      const rosterPlayers = team.players || [];
      const existingPlayers = existingStats?.players ? Object.keys(existingStats.players) : [];
      const playerSet = new Set([...rosterPlayers, ...existingPlayers]);

      const addPlayerRow = (playerName, statValues = {}, isRosterPlayer = false) => {
        const tr = document.createElement('tr');
        tr.dataset.playerName = playerName;

        const nameTd = document.createElement('td');
        nameTd.className = 'px-2';
        nameTd.textContent = playerName;
        tr.appendChild(nameTd);

        ['kills', 'assists', 'score', 'captures', 'returns', 'time'].forEach(stat => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.className = 'stat-input w-20 px-1 bg-gray-800 border border-gray-700';
          input.dataset.player = playerName;
          input.dataset.team = team.name;
          input.dataset.stat = stat;
          input.value = statValues[stat] ?? 0;
          td.appendChild(input);
          tr.appendChild(td);
        });

        const removeTd = document.createElement('td');
        removeTd.className = 'px-2';
        if (!isRosterPlayer) {
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'px-2 py-1 bg-red-600 hover:bg-red-700 rounded';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', () => {
            tbody.removeChild(tr);
            playerSet.delete(playerName);
          });
          removeTd.appendChild(removeBtn);
        }
        tr.appendChild(removeTd);

        tbody.appendChild(tr);
      };

      playerSet.forEach(p => {
        addPlayerRow(p, existingStats?.players?.[p] || {}, rosterPlayers.includes(p));
      });

      wrapper.appendChild(table);

      const addSubBtn = document.createElement('button');
      addSubBtn.type = 'button';
      addSubBtn.className = 'mt-2 px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded';
      addSubBtn.textContent = 'Add Sub Player';
      addSubBtn.addEventListener('click', () => {
        const name = prompt('Enter sub player name:');
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        if (playerSet.has(trimmed)) {
          alert('Player already exists in this team list.');
          return;
        }
        playerSet.add(trimmed);
        addPlayerRow(trimmed, {}, false);
      });

      wrapper.appendChild(addSubBtn);
      container.appendChild(wrapper);
    }

    function resetOutput() {
      document.getElementById('output').innerHTML = '';
      document.getElementById('exportBtn').disabled = true;
    }

    function buildSaveData(map, t1, t2) {
      const inputs = Array.from(document.querySelectorAll('.stat-input'));
      const stats = {};
      inputs.forEach(inp => {
        const player = inp.dataset.player;
        const team = inp.dataset.team;
        const stat = inp.dataset.stat;
        const val = toNumber(inp.value);
        if (!stats[team]) stats[team] = {};
        if (!stats[team][player]) stats[team][player] = { kills:0, assists:0, score:0, captures:0, returns:0, time:0 };
        stats[team][player][stat] = val;
      });

      const payload = { map, team1: t1.name, team2: t2.name, created: currentMatchCreated || new Date(), stats: {} };

      [t1.name, t2.name].forEach(teamName => {
        const teamStats = stats[teamName] || {};
        const totals = { kills:0, assists:0, score:0, captures:0, returns:0, time:0 };
        const playersPayload = {};
        Object.keys(teamStats).forEach(player => {
          const s = teamStats[player];
          totals.kills += s.kills;
          totals.assists += s.assists;
          totals.score += s.score;
          totals.captures += s.captures;
          totals.returns += s.returns;
          totals.time += s.time;
          const kpm = s.time ? (s.kills / s.time).toFixed(2) : '0';
          const apm = s.time ? (s.assists / s.time).toFixed(2) : '0';
          const spm = s.time ? (s.score / s.time).toFixed(2) : '0';
          const cpm = s.time ? (s.captures / s.time).toFixed(2) : '0';
          const rpm = s.time ? (s.returns / s.time).toFixed(2) : '0';
          playersPayload[player] = { ...s, kpm, apm, spm, cpm, rpm };
        });
        const teamKpm = totals.time ? (totals.kills / totals.time).toFixed(2) : '0';
        const teamApm = totals.time ? (totals.assists / totals.time).toFixed(2) : '0';
        const teamSpm = totals.time ? (totals.score / totals.time).toFixed(2) : '0';
        const teamCpm = totals.time ? (totals.captures / totals.time).toFixed(2) : '0';
        const teamRpm = totals.time ? (totals.returns / totals.time).toFixed(2) : '0';
        payload.stats[teamName] = {
          players: playersPayload,
          totals: { ...totals, kpm: teamKpm, apm: teamApm, spm: teamSpm, cpm: teamCpm, rpm: teamRpm }
        };
      });

      return payload;
    }

    function renderRunningTotals(statsByTeam = {}) {
      const output = document.getElementById('output');
      output.innerHTML = '';
      const teamNames = Object.keys(statsByTeam);
      if (!teamNames.length) {
        document.getElementById('exportBtn').disabled = true;
        return;
      }

      const exportTable = document.createElement('table');
      exportTable.id = 'exportTable';
      exportTable.className = 'min-w-full text-left border border-gray-700';
      exportTable.innerHTML = `
        <thead>
          <tr>
            <th class="px-2">Team</th>
            <th class="px-2">Player</th>
            <th class="px-2">Kills</th>
            <th class="px-2">Assists</th>
            <th class="px-2">Score</th>
            <th class="px-2">Captures</th>
            <th class="px-2">Returns</th>
            <th class="px-2">Time</th>
            <th class="px-2">KPM</th>
            <th class="px-2">APM</th>
            <th class="px-2">SPM</th>
            <th class="px-2">CPM</th>
            <th class="px-2">RPM</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = exportTable.querySelector('tbody');

      teamNames.forEach(teamName => {
        const teamStats = statsByTeam[teamName] || {};
        const players = teamStats.players || {};
        const totals = { kills:0, assists:0, score:0, captures:0, returns:0, time:0 };

        Object.keys(players).forEach(player => {
          const statEntry = players[player] || {};
          const kills = toNumber(statEntry.kills);
          const assists = toNumber(statEntry.assists);
          const score = toNumber(statEntry.score);
          const captures = toNumber(statEntry.captures);
          const returns = toNumber(statEntry.returns);
          const time = toNumber(statEntry.time);
          totals.kills += kills;
          totals.assists += assists;
          totals.score += score;
          totals.captures += captures;
          totals.returns += returns;
          totals.time += time;

          const kpm = time ? (kills / time).toFixed(2) : (statEntry.kpm ?? '0');
          const apm = time ? (assists / time).toFixed(2) : (statEntry.apm ?? '0');
          const spm = time ? (score / time).toFixed(2) : (statEntry.spm ?? '0');
          const cpm = time ? (captures / time).toFixed(2) : (statEntry.cpm ?? '0');
          const rpm = time ? (returns / time).toFixed(2) : (statEntry.rpm ?? '0');

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-2">${teamName}</td>
            <td class="px-2">${player}</td>
            <td class="px-2">${kills}</td>
            <td class="px-2">${assists}</td>
            <td class="px-2">${score}</td>
            <td class="px-2">${captures}</td>
            <td class="px-2">${returns}</td>
            <td class="px-2">${time}</td>
            <td class="px-2">${kpm}</td>
            <td class="px-2">${apm}</td>
            <td class="px-2">${spm}</td>
            <td class="px-2">${cpm}</td>
            <td class="px-2">${rpm}</td>
          `;
          tbody.appendChild(tr);
        });

        const totalsData = teamStats.totals || {};
        const totalKills = totalsData.kills ?? totals.kills;
        const totalAssists = totalsData.assists ?? totals.assists;
        const totalScore = totalsData.score ?? totals.score;
        const totalCaptures = totalsData.captures ?? totals.captures;
        const totalReturns = totalsData.returns ?? totals.returns;
        const totalTime = totalsData.time ?? totals.time;
        const teamKpm = totalTime ? (totalKills / totalTime).toFixed(2) : (totalsData.kpm ?? '0');
        const teamApm = totalTime ? (totalAssists / totalTime).toFixed(2) : (totalsData.apm ?? '0');
        const teamSpm = totalTime ? (totalScore / totalTime).toFixed(2) : (totalsData.spm ?? '0');
        const teamCpm = totalTime ? (totalCaptures / totalTime).toFixed(2) : (totalsData.cpm ?? '0');
        const teamRpm = totalTime ? (totalReturns / totalTime).toFixed(2) : (totalsData.rpm ?? '0');

        const trTot = document.createElement('tr');
        trTot.className = 'font-semibold';
        trTot.innerHTML = `
          <td class="px-2">${teamName}</td>
          <td class="px-2">Totals</td>
          <td class="px-2">${totalKills}</td>
          <td class="px-2">${totalAssists}</td>
          <td class="px-2">${totalScore}</td>
          <td class="px-2">${totalCaptures}</td>
          <td class="px-2">${totalReturns}</td>
          <td class="px-2">${totalTime}</td>
          <td class="px-2">${teamKpm}</td>
          <td class="px-2">${teamApm}</td>
          <td class="px-2">${teamSpm}</td>
          <td class="px-2">${teamCpm}</td>
          <td class="px-2">${teamRpm}</td>
        `;
        tbody.appendChild(trTot);
      });

      output.appendChild(exportTable);
      document.getElementById('exportBtn').disabled = false;
    }

    document.getElementById('saveMatch').addEventListener('click', async () => {
      const map = document.getElementById('map').value;
      const t1 = teamsData.find(t => t.id === document.getElementById('team1').value);
      const t2 = teamsData.find(t => t.id === document.getElementById('team2').value);
      if (!t1 || !t2) {
        alert('Please select two teams before saving.');
        return;
      }

      const saveData = buildSaveData(map, t1, t2);
      renderRunningTotals(saveData.stats);

      if (editingMatchId) {
        await updateDoc(doc(db, 'matches', editingMatchId), saveData);
        alert('Match updated!');
      } else {
        await addDoc(collection(db, 'matches'), saveData);
        alert('Match saved!');
      }
      editingMatchId = null;
      currentMatchCreated = null;
      document.getElementById('saveMatch').textContent = 'Save Match';
      loadMatches();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const table = document.getElementById('exportTable');
      const wb = XLSX.utils.table_to_book(table, { sheet: 'Stats' });
      XLSX.writeFile(wb, 'match-stats.xlsx');
    });
  </script>
  <script src="./assets/include.js" defer></script>
</body>
</html>
